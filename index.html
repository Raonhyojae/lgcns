<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- âœ… ì¶”ê°€í•  ì½”ë“œ -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#8b5cf6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="LG CNS ë¬¼í’ˆê´€ë¦¬">
<meta name="theme-color" content="#000000">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <title>LG CNS í†µí•© ë¬¼í’ˆê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
<style>
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
    --accent-color: #4facfe;
    --success-color: #28a745;
    --error-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --border-radius: 15px;
    --box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    --transition: all 0.3s ease;
}

      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      body { 
          font-family: 'Malgun Gothic', sans-serif; 
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: white;
      }

/* ì ‘ê·¼ì„± ê°œì„  */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* í¬ì»¤ìŠ¤ í‘œì‹œ ê°œì„  */
*:focus {
    outline: 3px solid rgba(255, 255, 255, 0.8);
    outline-offset: 2px;
}
     
      .container { 
          max-width: 1200px; 
          margin: 0 auto; 
          padding: 20px;
      }

      h1 { 
          text-align: center;
          margin-bottom: 30px; 
          font-size: 28px; 
          font-weight: bold;
          color: #fff;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
          background: rgba(255,255,255,0.1);
          padding: 20px;
          border-radius: 15px;
          backdrop-filter: blur(10px);
          display: flex;
          align-items: center;
          justify-content: center;
         gap: 20px;
      }
.lgcns-logo {
    width: 60px;
    height: 60px;
    object-fit: contain;
    filter: brightness(1.2);
}

.estream-logo {
    display: block;
    margin: 20px auto;
    width: 200px;
    height: auto;
    opacity: 0.8;
    transition: opacity 0.3s ease;
}

.estream-logo:hover {
    opacity: 1;
}
      .mode-tabs {
          display: flex;
          justify-content: center;
          margin-bottom: 30px;
          gap: 10px;
      }

      .mode-tab {
          padding: 15px 30px;
          background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
          color: rgba(255,255,255,0.8);
          border: 2px solid rgba(255,255,255,0.2);
          border-radius: 30px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 700;
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          position: relative;
          overflow: hidden;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      }

      .mode-tab:hover {
          transform: translateY(-3px);
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          border-color: rgba(255,255,255,0.4);
      }

      .mode-tab.active {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          color: white;
          border-color: rgba(255,255,255,0.6);
          box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
          transform: translateY(-2px);
      }

      .upload-section { 
          text-align: center; 
          margin-bottom: 30px; 
          padding: 20px; 
          background: rgba(255,255,255,0.1);
          border-radius: 15px;
          backdrop-filter: blur(10px);
      }
      
      .file-input-wrapper { 
          position: relative; 
          display: inline-block; 
          margin-bottom: 15px;
      }
      
      .file-input-wrapper input[type=file] { 
          position: absolute; 
          opacity: 0; 
          width: 100%; 
          height: 100%; 
          cursor: pointer; 
      }
      
      .file-input-label { 
          display: inline-block; 
          padding: 12px 25px; 
          background: rgba(255,255,255,0.2);
          color: white; 
          border-radius: 25px; 
          cursor: pointer; 
          font-size: 16px; 
          transition: all 0.3s ease;
          border: 2px solid rgba(255,255,255,0.3);
      }
      
      .file-input-label:hover { 
          background: rgba(255,255,255,0.3);
      }

      .upload-info {
          margin-top: 10px;
          font-size: 14px;
          color: rgba(255,255,255,0.8);
      }

      .file-rules {
          margin-top: 15px;
          padding: 15px;
          background: rgba(255,255,255,0.1);
          border-radius: 10px;
          border-left: 4px solid #ffc107;
          text-align: left;
          font-size: 13px;
          line-height: 1.6;
      }

      .file-rules h4 {
          color: #ffc107;
          margin-bottom: 8px;
          font-size: 14px;
      }

      .file-rules ul {
          list-style-type: none;
          padding-left: 0;
      }

      .file-rules li {
          margin-bottom: 5px;
          padding-left: 20px;
          position: relative;
      }

      .file-rules li:before {
          content: "â€¢";
          color: #ffc107;
          position: absolute;
          left: 0;
      }


.file-message {
    margin-top: 15px;
    padding: 15px;
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.6;
    text-align: center;
    font-weight: 600;
    transition: all 0.3s ease;
    display: none;
    color: white !important;
}

/* ì§„í–‰ë¥  í‘œì‹œë°” */
.progress-container {
    margin: 20px 0;
    display: none;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: rgba(255,255,255,0.2);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success-color) 0%, #20c997 100%);
    width: 0%;
    transition: width 0.3s ease;
    position: relative;
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

/* ë¡œë”© ìŠ¤í”¼ë„ˆ */
.loading-spinner {
    display: none;
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.file-message.success {
    background: rgba(40, 167, 69, 0.8);
    border: 2px solid #28a745;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.file-message.error {
    background: rgba(220, 53, 69, 0.8);
    border: 2px solid #dc3545;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}

.file-message.info {
    background: rgba(23, 162, 184, 0.8);
    border: 2px solid #17a2b8;
    box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
}

.file-message.show {
    display: block;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

      .controls { 
          display: flex; 
          justify-content: center; 
          align-items: center; 
          gap: 20px; 
          margin-bottom: 25px; 
          flex-wrap: wrap;
      }
      
      .date-display {
          padding: 15px 25px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border-radius: 30px;
          font-size: 16px;
          font-weight: 700;
          backdrop-filter: blur(10px);
          border: 3px solid rgba(255,255,255,0.3);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
          text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      }

      .btn { 
          padding: 15px 30px; 
          border: none; 
          border-radius: 30px; 
          cursor: pointer; 
          font-size: 16px; 
          font-weight: 700;
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          backdrop-filter: blur(10px);
          position: relative;
          overflow: hidden;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
          border: 2px solid rgba(255,255,255,0.3);
      }

      .btn-primary { 
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white; 
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary { 
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          color: white; 
          box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
      }

      .btn:hover {
          transform: translateY(-4px) scale(1.05);
          box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      }

      .receipt-wrapper {
          display: none;
          background: white;
          color: black;
          padding: 0px;
          margin-top: 30px;
          border-radius: 15px;
          width: 100%;
      }

      .receipt-wrapper.show {
          display: block;
      }

      .receipt-page { 
          width: 100%; 
          margin: 20px auto; 
          padding: 15mm; 
          background: white; 
          box-shadow: 0 15px 50px rgba(0,0,0,0.3);
          border-radius: 15px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
      }

      .receipt { 
          border: 2px solid #333; 
          padding: 20px; 
          margin-bottom: 5mm;
          border-radius: 8px;
          background: #fafafa;
          width: 100%;
          max-width: none;
      }

      .receipt h2 { 
          text-align: center; 
          margin-bottom: 25px; 
          font-size: 24px; 
          color: #333;
          border-bottom: 3px solid #667eea; 
          padding-bottom: 12px; 
          font-weight: 700;
      }

      .receipt-info { 
          margin-bottom: 30px; 
      }
      
      .cut-line::before { 
          content: "âœ‚ï¸ ì ˆì·¨ì„ "; 
          position: absolute; 
          left: 50%; 
          top: -12px; 
          transform: translateX(-50%); 
          background: white; 
          padding: 0 20px; 
          color: #667eea;
          font-weight: 600;
          font-size: 14px;
      }

      .toast {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          background: #28a745;
          color: white;
          border-radius: 8px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          z-index: 10000;
          opacity: 0;
          transform: translateX(100%);
          transition: all 0.3s ease;
          font-weight: 600;
          max-width: 350px;
          word-wrap: break-word;
      }

      .toast.show {
          opacity: 1;
          transform: translateX(0);
      }

      .toast.error {
          background: #dc3545;
      }

      @media print {
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    
    body {
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
        font-family: 'Malgun Gothic', sans-serif !important;
    }
    
    .container > *:not(.receipt-wrapper) {
        display: none !important;
    }
    
    .receipt-wrapper {
        display: block !important;
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }
    
    /* ğŸ”¥ í•µì‹¬ ìˆ˜ì •: í•œ í˜ì´ì§€ì— 2ê°œì”© ì¸ì‡„ */
    .receipt-page {
        width: 210mm !important;
        height: 148.5mm !important; /* A4 ì„¸ë¡œì˜ ì ˆë°˜ ë†’ì´ */
        margin: 0 !important;
        padding: 10mm !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        background: white !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start !important;
        page-break-inside: avoid !important;
        page-break-after: auto !important;
    }

    /* 2ê°œë§ˆë‹¤ í˜ì´ì§€ ë‚˜ëˆ„ê¸° */
    .receipt-page:nth-child(2n) {
        page-break-after: always !important;
    }

    /* ë§ˆì§€ë§‰ í˜ì´ì§€ëŠ” í˜ì´ì§€ ë‚˜ëˆ„ê¸° ì•ˆí•¨ */
    .receipt-page:last-child {
        page-break-after: avoid !important;
    }
    
    .receipt {
        border: 2px solid #333 !important;
        padding: 12px !important;
        margin-bottom: 5mm !important;
        border-radius: 8px !important;
        background: #fafafa !important;
        width: 100% !important;
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    .receipt h2 {
        text-align: center !important;
        margin-bottom: 15px !important;
        font-size: 18px !important;
        color: #333 !important;
        border-bottom: 2px solid #667eea !important;
        padding-bottom: 8px !important;
        font-weight: 700 !important;
    }
    
    .receipt-info {
        margin-bottom: 20px !important;
        flex: 1 !important;
    }
    
    .receipt-info > div {
        margin-bottom: 8px !important;
        font-size: 12px !important;
        display: flex !important;
        align-items: center !important;
    }
    
    .receipt-info strong {
        width: 100px !important;
        font-size: 12px !important;
        font-weight: bold !important;
        color: #333 !important;
        background: #f8f9fa !important;
        padding: 8px 10px !important;
        border: 1px solid #ddd !important;
        border-right: none !important;
        border-radius: 4px 0 0 4px !important;
    }
    
    .receipt-info .value {
        flex: 1 !important;
        padding: 8px 10px !important;
        border: 1px solid #ddd !important;
        background: white !important;
        border-radius: 0 4px 4px 0 !important;
        font-size: 12px !important;
    }
    
    .signature-section {
        margin-top: 15px !important;
        padding: 10px !important;
        border-top: 1px solid #eee !important;
        display: flex !important;
        justify-content: center !important;
        gap: 30px !important;
    }
    
    .signature-section > div {
        text-align: center !important;
    }
    
    .signature-section > div > div:first-child {
        font-size: 14px !important;
        font-weight: bold !important;
        margin-bottom: 10px !important;
    }
    
    .signature-box {
        width: 120px !important;
        height: 40px !important;
        border: 2px solid #333 !important;
        background: white !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 12px !important;
        color: #999 !important;
    }
    
    .signature-box.signed {
        background-size: contain !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        color: transparent !important;
    }
    
       
    .cut-line::before {
        content: "âœ‚ï¸ ì ˆì·¨ì„ " !important;
        position: absolute !important;
        left: 50% !important;
        top: -8px !important;
        transform: translateX(-50%) !important;
        background: white !important;
        padding: 0 10px !important;
        color: #667eea !important;
        font-weight: 600 !important;
        font-size: 10px !important;
    }
    
    /* íšŒìˆ˜í™•ì¸ì„œìš© ì„œëª… ìŠ¤íƒ€ì¼ */
    .signature-row {
        display: flex !important;
        justify-content: center !important;
        gap: 40px !important;
        align-items: flex-end !important;
        margin-top: 15px !important;
    }
    
    .signature-group {
        display: flex !important;
        align-items: flex-end !important;
        gap: 10px !important;
    }
    
    .signature-title {
        font-size: 12px !important;
        font-weight: bold !important;
        color: #333 !important;
        margin-bottom: 2px !important;
    }
    
    .signature-line {
        width: 80px !important;
        height: 1px !important;
        border-bottom: 2px solid #333 !important;
        margin: 0 5px !important;
        margin-bottom: 2px !important;
    }
    
    /* ë°”ì½”ë“œ ê´€ë ¨ ìˆ¨ê¸°ê¸° */
    .barcode-modal, .signature-modal {
        display: none !important;
    }
    
    /* ì‹œë¦¬ì–¼ë²ˆí˜¸ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
    .serial-input {
        flex: 1 !important;
        padding: 8px 10px !important;
        border: 1px solid #ddd !important;
        background: white !important;
        border-radius: 0 4px 4px 0 !important;
        font-size: 12px !important;
    }
    
    .barcode-scan-btn {
        display: none !important;
    }
}

.cut-line {
    border-top: 2px dashed #667eea !important;
    margin: 1mm auto 8mm auto !important;
    position: relative !important;
    text-align: center !important;
    width: 100% !important;
}
    
    .cut-line::before {
        content: "âœ‚ï¸ ì ˆì·¨ì„ " !important;
        position: absolute !important;
        left: 50% !important;
        top: -10px !important;
        transform: translateX(-50%) !important;
        background: white !important;
        padding: 0 15px !important;
        color: #667eea !important;
        font-weight: 600 !important;
        font-size: 12px !important;
    }

/* íšŒìˆ˜í™•ì¸ì„œ ì „ìš© ìŠ¤íƒ€ì¼ */
.receipt-info p {
    display: flex;
    margin-bottom: 15px;
    align-items: center;
    font-size: 16px;
}

.receipt-info p strong {
    width: 140px;
    font-weight: bold;
    color: #333;
    background: #f8f9fa;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-right: none;
    border-radius: 4px 0 0 4px;
}

.receipt-info p .value {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 0 4px 4px 0;
    min-height: 20px;
}

.signature-section {
    margin-top: 40px;
    padding: 20px;
    border-top: 2px solid #eee;
}

.signature-row {
    display: flex;
    justify-content: center;
    gap: 40px;
    align-items: flex-end;
    margin-top: 20px;
}

.signature-group {
    display: flex;
    align-items: flex-end;
    gap: 15px;
}

.signature-title {
    font-size: 18px;
    font-weight: bold;
    color: #333;
}

.signature-line {
    width: 150px;
    height: 1px;
    border-bottom: 2px solid #333;
    margin: 0 10px;
    align-self: flex-end;
    margin-bottom: 2px;
}

      /* ì„œëª… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ - ì—¬ê¸°ë¶€í„° ì¶”ê°€ */
      .signature-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: none;
    justify-content: center;
    align-items: center;
}

.signature-modal.show {
    display: flex !important;
}

      .signature-popup {
          background: white;
          border-radius: 15px;
          padding: 30px;
          max-width: 90vw;
          max-height: 90vh;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          position: relative;
      }

      .signature-header {
          text-align: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 2px solid #667eea;
      }

      .signature-header h3 {
          color: #333;
          font-size: 24px;
          font-weight: 700;
          margin-bottom: 10px;
      }

      .signature-header p {
          color: #666;
          font-size: 16px;
      }

      .signature-canvas {
          border: 3px solid #667eea;
          border-radius: 10px;
          cursor: crosshair;
          touch-action: none;
          background: white;
          display: block;
          margin: 0 auto;
      }

      .signature-controls {
          display: flex;
          justify-content: center;
          gap: 15px;
          margin-top: 20px;
          flex-wrap: wrap;
      }

      .signature-btn {
          padding: 12px 25px;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          transition: all 0.3s ease;
          min-width: 120px;
      }

      .signature-btn.clear {
          background: #dc3545;
          color: white;
      }

      .signature-btn.clear:hover {
          background: #c82333;
          transform: translateY(-2px);
      }

      .signature-btn.save {
          background: #28a745;
          color: white;
      }

      .signature-btn.save:hover {
          background: #218838;
          transform: translateY(-2px);
      }

      .signature-btn.cancel {
          background: #6c757d;
          color: white;
      }

      .signature-btn.cancel:hover {
          background: #5a6268;
          transform: translateY(-2px);
      }

      .signature-box {
          border: 2px solid #333;
          height: 80px;
          width: 250px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #999;
          font-size: 16px;
          background: white;
          cursor: pointer;
          transition: all 0.3s ease;
          border-radius: 5px;
          position: relative;
          overflow: hidden;
      }

      .signature-box:hover {
          border-color: #667eea;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }

      .signature-box.signed {
          background-size: contain;
          background-repeat: no-repeat;
          background-position: center;
          color: transparent;
          border-color: #28a745;
      }

      .signature-box.signed::after {
          content: "âœ“ ì„œëª…ì™„ë£Œ";
          position: absolute;
          bottom: 5px;
          right: 5px;
          background: #28a745;
          color: white;
          padding: 2px 6px;
          border-radius: 3px;
          font-size: 10px;
          font-weight: 600;
      }

      @media print {
          .signature-modal {
              display: none !important;
          }
          
          .signature-box.signed::after {
              display: none !important;
          }
/* ì¸ì‡„ìš© ì„œëª… ì •ë ¬ ìµœì í™” */
@media print {
    .signature-section {
        margin-top: 30px !important;
        padding: 15px !important;
        border-top: 2px solid #eee !important;
    }
    
    .signature-row {
        display: flex !important;
        justify-content: center !important;
        gap: 50px !important;
        align-items: flex-end !important;
        margin-top: 15px !important;
        width: 100% !important;
    }
    
    .signature-group {
        display: flex !important;
        align-items: flex-end !important;
        gap: 10px !important;
        white-space: nowrap !important;
    }
    
    .signature-title {
        font-size: 14px !important;
        font-weight: bold !important;
        color: #333 !important;
        margin-bottom: 2px !important;
    }
    
    .signature-line {
        width: 100px !important;
        height: 1px !important;
        border-bottom: 2px solid #333 !important;
        margin: 0 5px !important;
        margin-bottom: 2px !important;
        flex-shrink: 0 !important;
    }
}
      }
/* ì„œëª… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ - ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ */

/* ë°”ì½”ë“œ ìŠ¤ìº” ê´€ë ¨ ìŠ¤íƒ€ì¼ */
.barcode-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 10px;
}

.barcode-scan-btn {
    padding: 8px 12px;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.barcode-scan-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
}

.barcode-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 10001;
    display: none;
    justify-content: center;
    align-items: center;
}

.barcode-modal.show {
    display: flex !important;
}

.barcode-popup {
    background: white;
    border-radius: 15px;
    padding: 20px;
    max-width: 90vw;
    max-height: 90vh;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    position: relative;
}

.barcode-header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #28a745;
}

.barcode-header h3 {
    color: #333;
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
}

.barcode-video {
    width: 100%;
    max-width: 500px;
    height: 300px;
    border: 3px solid #28a745;
    border-radius: 10px;
    background: #000;
}

.barcode-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.barcode-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 120px;
}

.barcode-btn.close {
    background: #dc3545;
    color: white;
}

.barcode-btn.close:hover {
    background: #c82333;
    transform: translateY(-2px);
}

.barcode-result {
    margin-top: 15px;
    padding: 10px;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 5px;
    color: #155724;
    text-align: center;
    display: none;
}

@media print {
    .barcode-modal {
        display: none !important;
    }
}

        /* ëª¨ë°”ì¼ ìµœì í™” ìŠ¤íƒ€ì¼ */
        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 0;
            }
            
            .mode-tab {
                padding: 15px 20px;
                font-size: 16px;
                margin: 5px;
            }
            
            .file-input-label {
                padding: 20px 25px;
                font-size: 18px;
                display: block;
                margin: 15px 0;
                text-align: center;
            }
            
            .btn {
                padding: 15px 25px;
                font-size: 16px;
                margin: 8px 5px;
                min-height: 50px;
                display: inline-block;
                width: calc(50% - 10px);
                box-sizing: border-box;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .barcode-popup {
                max-width: 95vw;
                max-height: 90vh;
                padding: 15px;
                margin: 20px auto;
            }
            
            .barcode-video {
                width: 100%;
                height: 280px;
                border-radius: 10px;
            }
            
            .signature-popup {
                max-width: 95vw;
                max-height: 85vh;
                padding: 15px;
                margin: 20px auto;
            }
            
            .signature-canvas {
                width: 100%;
                max-width: 100%;
                height: 200px;
                border-radius: 8px;
            }
            
            .signature-controls, .barcode-controls {
                flex-direction: column;
                gap: 12px;
                margin-top: 15px;
            }
            
            .signature-btn, .barcode-btn {
                width: 100%;
                padding: 18px;
                font-size: 16px;
                border-radius: 8px;
            }
            
            /* í…Œì´ë¸” ëª¨ë°”ì¼ ìµœì í™” */
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px;
                word-break: break-all;
            }
            
            /* ë©”ì‹œì§€ ë°•ìŠ¤ ëª¨ë°”ì¼ ìµœì í™” */
            .message {
                font-size: 14px;
                padding: 12px;
                margin: 10px 0;
            }
            
            /* ì¸ìˆ˜í™•ì¸ì„œ ëª¨ë°”ì¼ ìµœì í™” */
            .receipt {
                padding: 20px !important;
            }
            
            .receipt h2 {
                font-size: 20px !important;
            }
            
            .receipt-info div {
                flex-direction: column !important;
                margin-bottom: 12px !important;
            }
            
            .receipt-info strong {
                width: 100% !important;
                margin-bottom: 5px !important;
                border-radius: 4px !important;
                border-right: 1px solid #ddd !important;
            }
            
            .receipt-info .value, .serial-input {
                width: 100% !important;
                border-radius: 4px !important;
            }
            
            .barcode-input-wrapper {
                flex-direction: column !important;
                gap: 8px !important;
            }
            
            .barcode-scan-btn {
                width: 100% !important;
                padding: 12px !important;
            }
            
            .signature-section {
                flex-direction: column !important;
                gap: 20px !important;
                text-align: center !important;
            }
            
            .signature-box {
                width: 200px !important;
                height: 60px !important;
                margin: 0 auto !important;
            }
        }

        /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover,
            .mode-tab:hover,
            .file-input-label:hover {
                transform: none;
                box-shadow: none;
            }
            
            .btn:active,
            .mode-tab:active,
            .file-input-label:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
            
            /* í„°ì¹˜ ì˜ì—­ í™•ëŒ€ */
            .btn, .mode-tab, .file-input-label {
                min-height: 48px;
                touch-action: manipulation;
            }
            
            .signature-box {
                min-height: 60px;
                touch-action: manipulation;
            }
            
            .barcode-scan-btn {
                min-height: 44px;
                touch-action: manipulation;
            }
        }

        /* ì„¸ë¡œ ëª¨ë“œ ìµœì í™” */
        @media screen and (max-width: 480px) and (orientation: portrait) {
            .barcode-video {
                height: 250px;
            }
            
            .signature-canvas {
                height: 180px;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            
            .controls {
                padding: 10px;
            }
            
            .date-display {
                font-size: 14px;
                padding: 12px 20px;
            }
        }

        /* ê°€ë¡œ ëª¨ë“œ ìµœì í™” */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .barcode-popup {
                max-height: 95vh;
                padding: 10px;
            }
            
            .barcode-video {
                height: 200px;
            }
            
            .signature-popup {
                max-height: 90vh;
                padding: 10px;
            }
            
            .signature-canvas {
                height: 120px;
            }
            
            .signature-controls, .barcode-controls {
                flex-direction: row;
                justify-content: center;
                gap: 10px;
            }
            
            .signature-btn, .barcode-btn {
                width: auto;
                min-width: 100px;
                padding: 12px 20px;
            }
        }

        /* ì•„ì´í° Safari ìµœì í™” */
        @supports (-webkit-touch-callout: none) {
            .signature-canvas {
                touch-action: none;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
            }
            
            .barcode-video {
                -webkit-playsinline: true;
                object-fit: cover;
            }
        }

</style>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
</head>
<body>
  <div class="container">
      <h1>
<img src="https://raw.githubusercontent.com/Raonhyojae/lgcns/main/images/lgcns_logo.png" 
     alt="LG CNS" 
     class="lgcns-logo" 
     style="width: 200px; height: auto;">

    ğŸ¢ LG CNS í†µí•© ë¬¼í’ˆê´€ë¦¬ ì‹œìŠ¤í…œ
</h1>
      
      <div class="mode-tabs">
          <div class="mode-tab active" data-mode="receipt">ğŸ“¤ íšŒìˆ˜í™•ì¸ì„œ</div>
          <div class="mode-tab" data-mode="delivery">ğŸ“¥ ì¸ìˆ˜í™•ì¸ì„œ</div>
      </div>

      <div class="upload-section">
          <h3>ğŸ“Š ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>
          <div class="file-input-wrapper">
              <input type="file" id="fileInput" accept=".xlsx,.xls" />
              <label for="fileInput" class="file-input-label">ğŸ“ íŒŒì¼ ì„ íƒ</label>
          </div>
          <div class="upload-info">ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</div>

<div class="progress-container">
    <div class="progress-bar">
        <div class="progress-fill"></div>
        <div class="progress-text">0%</div>
    </div>
</div>
<div class="loading-spinner"></div>
          
          <div class="file-rules">
    <h4>ğŸ“‹ íŒŒì¼ ì—…ë¡œë“œ ê·œì¹™</h4>
    <ul id="fileRules">
        <li>íšŒìˆ˜í™•ì¸ì„œ ëª¨ë“œ: "íšŒìˆ˜" ê´€ë ¨ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥</li>
        <li>ì¸ìˆ˜í™•ì¸ì„œ ëª¨ë“œ: "ë‚©í’ˆ" ë˜ëŠ” "ì¸ìˆ˜" ê´€ë ¨ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥</li>
        <li>íŒŒì¼ëª…ì— í•´ë‹¹ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤</li>
    </ul>
    
    <!-- íŒŒì¼ ë©”ì‹œì§€ ë°•ìŠ¤ ì¶”ê°€ -->
    <div class="file-message" id="fileMessage"></div>
</div>

      <div class="controls">
          <div class="date-display">
              <span>ğŸ“… </span>
              <span id="currentDate">ë¡œë”©ì¤‘...</span>
          </div>
          <button class="btn btn-primary" onclick="generateReceipt()">ğŸ“‹ í™•ì¸ì„œ ìƒì„±</button>
          <button class="btn btn-secondary" onclick="printReceipt()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
      </div>
      </div>

      <img src="https://raw.githubusercontent.com/Raonhyojae/lgcns/main/images/estream_logo.png" alt="eSTREAM" class="estream-logo">

      <div class="receipt-wrapper" id="receiptWrapper">
          <div id="receiptContainer"></div>
      </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Service Worker ë“±ë¡
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

      // ì „ì—­ ë³€ìˆ˜
      let currentMode = 'receipt';
      let excelData = [];

// ğŸ›¡ï¸ ë³´ì•ˆ ë° ì„±ëŠ¥ ê°œì„  í•¨ìˆ˜ë“¤
function sanitizeInput(input) {
    if (typeof DOMPurify !== 'undefined') {
        return DOMPurify.sanitize(String(input));
    }
    return String(input).replace(/[<>]/g, '');
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ë©”ëª¨ë¦¬ ì •ë¦¬ í•¨ìˆ˜
function cleanupMemory() {
    if (window.gc) {
        window.gc();
    }
}

// ê¶Œí•œ ì²´í¬ í•¨ìˆ˜ë“¤
async function checkCameraPermission() {
    try {
        if (!navigator.permissions) {
            console.log('âš ï¸ Permissions API ë¯¸ì§€ì›');
            return 'unknown';
        }
        
        const permission = await navigator.permissions.query({ name: 'camera' });
        console.log('ğŸ“· ì¹´ë©”ë¼ ê¶Œí•œ ìƒíƒœ:', permission.state);
        return permission.state;
        
    } catch (error) {
        console.log('âš ï¸ ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨:', error);
        return 'unknown';
    }
}

function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

      // íŒŒì¼ëª… ê²€ì¦ ê·œì¹™
      const fileValidationRules = {
          receipt: {
              allowed: ['íšŒìˆ˜', 'íšŒìˆ˜ë¦¬ìŠ¤íŠ¸', 'íšŒìˆ˜ëª©ë¡', 'ë°˜ë‚©'],
              blocked: ['ë‚©í’ˆ', 'ìì‚°ë‚©í’ˆ', 'ì¸ìˆ˜', 'ë°°ì†¡', 'ì „ë‹¬'],
              message: 'íšŒìˆ˜í™•ì¸ì„œ ëª¨ë“œì—ì„œëŠ” "íšŒìˆ˜" ê´€ë ¨ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
          },
          delivery: {
              allowed: ['ë‚©í’ˆ', 'ìì‚°ë‚©í’ˆ', 'ì¸ìˆ˜', 'ë°°ì†¡', 'ì „ë‹¬', 'ì¸ìˆ˜ë¦¬ìŠ¤íŠ¸'],
              blocked: ['íšŒìˆ˜', 'íšŒìˆ˜ë¦¬ìŠ¤íŠ¸', 'ë°˜ë‚©'],
              message: 'ì¸ìˆ˜í™•ì¸ì„œ ëª¨ë“œì—ì„œëŠ” "ë‚©í’ˆ" ë˜ëŠ” "ì¸ìˆ˜" ê´€ë ¨ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
          }
      };

      // DOMì´ ë¡œë“œë˜ë©´ ì‹¤í–‰
      document.addEventListener('DOMContentLoaded', function() {
          console.log('ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');
          
          // ë‚ ì§œ ì—…ë°ì´íŠ¸ ì‹œì‘
          updateCurrentDate();
          setInterval(updateCurrentDate, 1000);
          
          // íŒŒì¼ ê·œì¹™ ì—…ë°ì´íŠ¸
          updateFileRules();
          
          // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
          setupEventListeners();
          
          // ì´ˆê¸°í™” ì™„ë£Œ ì•Œë¦¼
          setTimeout(() => {
              showMessage('âœ… ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          }, 500);
      });

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      function setupEventListeners() {
          // ëª¨ë“œ íƒ­ í´ë¦­ ì´ë²¤íŠ¸
          document.querySelectorAll('.mode-tab').forEach(tab => {
              tab.addEventListener('click', function() {
                  const mode = this.getAttribute('data-mode');
                  switchMode(mode);
              });
          });

          // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
          const fileInput = document.getElementById('fileInput');
          fileInput.addEventListener('change', handleFileUpload);
          
          console.log('âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
      }

      // í˜„ì¬ ë‚ ì§œ ì—…ë°ì´íŠ¸
      function updateCurrentDate() {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');
          
          const dateString = `${year}ë…„ ${month}ì›” ${day}ì¼ ${hours}:${minutes}:${seconds}`;
          
          const dateElement = document.getElementById('currentDate');
          if (dateElement) {
              dateElement.textContent = dateString;
          }
      }

      // íŒŒì¼ ê·œì¹™ ì—…ë°ì´íŠ¸
      function updateFileRules() {
          const rulesElement = document.getElementById('fileRules');
          const rules = fileValidationRules[currentMode];
          
          rulesElement.innerHTML = `
              <li><strong>${currentMode === 'receipt' ? 'íšŒìˆ˜í™•ì¸ì„œ' : 'ì¸ìˆ˜í™•ì¸ì„œ'} ëª¨ë“œ</strong></li>
              <li>í—ˆìš© í‚¤ì›Œë“œ: ${rules.allowed.join(', ')}</li>
              <li>ì°¨ë‹¨ í‚¤ì›Œë“œ: ${rules.blocked.join(', ')}</li>
              <li>íŒŒì¼ëª…ì— í—ˆìš© í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤</li>
          `;
      }

      // íŒŒì¼ëª… ê²€ì¦
      function validateFileName(fileName) {
          const rules = fileValidationRules[currentMode];
          const lowerFileName = fileName.toLowerCase();
          
          // ì°¨ë‹¨ëœ í‚¤ì›Œë“œ í™•ì¸
          for (let blocked of rules.blocked) {
              if (lowerFileName.includes(blocked.toLowerCase())) {
                  return {
                      valid: false,
                      message: `âŒ "${blocked}" í‚¤ì›Œë“œê°€ í¬í•¨ëœ íŒŒì¼ì€ í˜„ì¬ ëª¨ë“œì—ì„œ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
                  };
              }
          }
          
          // í—ˆìš©ëœ í‚¤ì›Œë“œ í™•ì¸
          let hasAllowedKeyword = false;
          for (let allowed of rules.allowed) {
              if (lowerFileName.includes(allowed.toLowerCase())) {
                  hasAllowedKeyword = true;
                  break;
              }
          }
          
          if (!hasAllowedKeyword) {
              return {
                  valid: false,
                  message: `âŒ í—ˆìš©ëœ í‚¤ì›Œë“œ(${rules.allowed.join(', ')})ê°€ íŒŒì¼ëª…ì— í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`
              };
          }
          
          return { valid: true, message: 'âœ… íŒŒì¼ëª… ê²€ì¦ í†µê³¼' };
      }

      // ëª¨ë“œ ì „í™˜
      function switchMode(mode) {
          console.log('ğŸ”„ ëª¨ë“œ ì „í™˜:', mode);
          currentMode = mode;
          
          // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
          document.querySelectorAll('.mode-tab').forEach(tab => {
              tab.classList.remove('active');
          });
          document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

          // íŒŒì¼ ê·œì¹™ ì—…ë°ì´íŠ¸
          updateFileRules();

          // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
          excelData = [];
          document.getElementById('receiptWrapper').classList.remove('show');
          document.getElementById('fileInput').value = '';

          const modeText = mode === 'receipt' ? 'íšŒìˆ˜í™•ì¸ì„œ' : 'ì¸ìˆ˜í™•ì¸ì„œ';
          showMessage(`${modeText} ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
      }

      // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
      function handleFileUpload(event) {
    console.log('ğŸ“ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘');
    
    const file = event.target.files[0];
    if (!file) return;

    console.log('ì„ íƒëœ íŒŒì¼:', file.name);
    
    // íŒŒì¼ í¬ê¸° ì œí•œ (50MB)
    const maxSize = 50 * 1024 * 1024;
    if (file.size > maxSize) {
        showMessage(`âŒ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€ ${formatFileSize(maxSize)})`, 'error');
        event.target.value = '';
        return;
    }
    
    // íŒŒì¼ íƒ€ì… ê²€ì¦ ê°•í™”
    const allowedTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
    const allowedExtensions = /\.(xlsx|xls)$/i;
    
    if (!allowedTypes.includes(file.type) && !allowedExtensions.test(file.name)) {
        showMessage('âŒ ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
        event.target.value = '';
        return;
    }
    
    // íŒŒì¼ëª… ê²€ì¦
    const validation = validateFileName(file.name);
    if (!validation.valid) {
        showMessage(validation.message, 'error');
        event.target.value = '';
        return;
    }

    showMessage('ğŸ“„ íŒŒì¼ ê²€ì¦ ì™„ë£Œ. ì½ëŠ” ì¤‘...', 'info');
    
    // ì§„í–‰ë¥  í‘œì‹œ
    const progressContainer = document.querySelector('.progress-container');
    if (progressContainer) {
        progressContainer.style.display = 'block';
        updateProgress(10);
    }

    const reader = new FileReader();
    
    reader.onprogress = function(e) {
        if (e.lengthComputable) {
            const percentLoaded = Math.round((e.loaded / e.total) * 70) + 10; // 10-80%
            updateProgress(percentLoaded);
        }
    };
    
    reader.onload = function(e) {
        try {
            updateProgress(90);
            
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { 
                type: 'array',
                cellStyles: false,
                cellNF: false,
                sheetStubs: false
            });
            
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            excelData = XLSX.utils.sheet_to_json(worksheet, { 
                header: 1,
                defval: '',
                blankrows: false
            });
            
            updateProgress(100);
            
            if (excelData.length > 1) {
                const dataRows = excelData.length - 1;
                showMessage(`âœ… íŒŒì¼ ë¡œë“œ ì„±ê³µ! ${dataRows}ê°œ í•­ëª©`, 'success');
            } else {
                showMessage('âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }
            
            // ì§„í–‰ë¥  ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }
            }, 1000);
            
            // ë©”ëª¨ë¦¬ ì •ë¦¬
            setTimeout(cleanupMemory, 2000);
            
        } catch (error) {
            console.error('íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜:', error);
            showMessage('âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ' + error.message, 'error');
            
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
        }
    };
    
    reader.onerror = function() {
        showMessage('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨', 'error');
        if (progressContainer) {
            progressContainer.style.display = 'none';
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateProgress(percent) {
    const progressFill = document.querySelector('.progress-fill');
    const progressText = document.querySelector('.progress-text');
    
    if (progressFill) {
        progressFill.style.width = percent + '%';
    }
    
    if (progressText) {
        progressText.textContent = percent + '%';
    }
}

// í™•ì¸ì„œ ìƒì„± í•¨ìˆ˜ì—ì„œ ì¸ìˆ˜í™•ì¸ì„œ ë¶€ë¶„ë§Œ ìˆ˜ì •
function generateReceipt() {
    if (excelData.length === 0) {
        showMessage('âŒ ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    const receiptWrapper = document.getElementById('receiptWrapper');
    const receiptContainer = document.getElementById('receiptContainer');
    
    let receiptsHTML = '';
    const currentDate = new Date().toLocaleDateString('ko-KR');
    
    if (currentMode === 'receipt') {
        // ê¸°ì¡´ íšŒìˆ˜í™•ì¸ì„œ ë¡œì§ ìœ ì§€ (ìˆ˜ì •í•˜ì§€ ì•ŠìŒ)
        const groupedData = {};
        
        for (let i = 5; i < excelData.length; i++) {
            const row = excelData[i];
            if (row && row.length > 0) {
                const assetNumber = row[0] ? String(row[0]).trim() : '';
                
                if (!assetNumber || !/^\d/.test(assetNumber)) {
                    continue;
                }
                
                const collectionNumber = row[1] ? String(row[1]).trim() : '';
                if (!collectionNumber) {
                    continue;
                }
                
                const assetType = row[2] ? String(row[2]).trim() : '';
                const modelName = row[3] ? String(row[3]).trim() : '';
                const contactPerson = row[9] ? String(row[9]).trim() : '';
                const phoneNumber = row[10] ? String(row[10]).trim() : '';
                
                if (!groupedData[collectionNumber]) {
                    groupedData[collectionNumber] = {
                        assetNumbers: [],
                        assetItems: [],
                        contactPerson: contactPerson,
                        phoneNumber: phoneNumber
                    };
                }
                
                if (!groupedData[collectionNumber].assetNumbers.includes(assetNumber)) {
                    groupedData[collectionNumber].assetNumbers.push(assetNumber);
                }
                
                const assetItem = `${assetType} ${modelName}`.trim();
                if (assetItem && !groupedData[collectionNumber].assetItems.includes(assetItem)) {
                    groupedData[collectionNumber].assetItems.push(assetItem);
                }
            }
        }
        
        Object.keys(groupedData).forEach(collectionNumber => {
            const data = groupedData[collectionNumber];
            const assetNumbers = data.assetNumbers.join(', ');
            const assetList = data.assetItems.join(', ');
            const returnPersonInfo = `${data.contactPerson} ${data.phoneNumber}`.trim();
            
            receiptsHTML += `
                <div class="receipt-page">
                    <div class="receipt">
                        <h2>LG CNS íšŒìˆ˜ í™•ì¸ì„œ(íšŒìˆ˜ì)</h2>
                        <div class="receipt-info">
                            <p><strong>ìì‚°ë²ˆí˜¸</strong><span class="value">${assetNumbers}</span></p>
                            <p><strong>íšŒìˆ˜ì½”ë“œ</strong><span class="value">${collectionNumber}</span></p>
                            <p><strong>ë°˜ë‚©ìì‚°ëª©ë¡</strong><span class="value">${assetList}</span></p>
                            <p><strong>ë°˜ë‚©ìì •ë³´</strong><span class="value">${returnPersonInfo}</span></p>
                            <p><strong>íšŒìˆ˜ì¼ì</strong><span class="value">${currentDate}</span></p>
                        </div>
                        <div class="signature-section">
                <div class="signature-row" style="justify-content: center !important;">
                    <div class="signature-group">
                        <span class="signature-title">íšŒìˆ˜ì :</span>
                        <div class="signature-line"></div>
                        <span style="margin-left: 10px;">ì¸</span>
                    </div>
                    <div class="signature-group" style="margin-left: 10px;">
                        <span class="signature-title">ë°˜ë‚©ì :</span>
                        <div class="signature-line"></div>
                        <span style="margin-left: 10px;">ì¸</span>
                    </div>
                            </div>
                        </div>
                    </div>
                    <div class="cut-line"></div>
                    <div class="receipt">
                        <h2>LG CNS íšŒìˆ˜ í™•ì¸ì„œ(ë°˜ë‚©ì)</h2>
                        <div class="receipt-info">
                            <p><strong>ìì‚°ë²ˆí˜¸</strong><span class="value">${assetNumbers}</span></p>
                            <p><strong>íšŒìˆ˜ì½”ë“œ</strong><span class="value">${collectionNumber}</span></p>
                            <p><strong>ë°˜ë‚©ìì‚°ëª©ë¡</strong><span class="value">${assetList}</span></p>
                            <p><strong>ë°˜ë‚©ìì •ë³´</strong><span class="value">${returnPersonInfo}</span></p>
                            <p><strong>íšŒìˆ˜ì¼ì</strong><span class="value">${currentDate}</span></p>
                        </div>
                        <div class="signature-section">
                            <div class="signature-row" style="justify-content: center !important;">
                                <div class="signature-group">
                                    <span class="signature-title">íšŒìˆ˜ì :</span>
                                    <div class="signature-line"></div>
                                    <span style="margin-left: 10px;">ì¸</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
} else if (currentMode === 'delivery') {
        // ìƒˆë¡œìš´ ì¸ìˆ˜í™•ì¸ì„œ ë¡œì§ - ì—‘ì…€ êµ¬ì¡°ì— ë§ì¶¤
        console.log('ğŸ“Š ì¸ìˆ˜í™•ì¸ì„œ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
        
        // ê³„ì•½ë²ˆí˜¸ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í•‘
        const groupedByContract = {};
        
        // 3í–‰ê¹Œì§€ëŠ” íƒ€ì´í‹€ì´ë¯€ë¡œ 4í–‰ë¶€í„° ì²˜ë¦¬ (ì¸ë±ìŠ¤ 3ë¶€í„°)
        for (let i = 3; i < excelData.length; i++) {
            const row = excelData[i];
            
            // ë¹ˆ í–‰ì´ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ í–‰ ìŠ¤í‚µ
            if (!row || row.length === 0 || !row.some(cell => cell)) {
                continue;
            }
            
            // Aì—´: ê³„ì•½ë²ˆí˜¸, Bì—´: ì œí’ˆëª…, Cì—´: ìˆ˜ëŸ‰, Hì—´: ê²€ìˆ˜ì (ì¸ë±ìŠ¤ 7)
            const contractNumber = row[0] ? String(row[0]).trim() : '';
            const productName = row[1] ? String(row[1]).trim() : '';
            const quantity = row[2] ? parseInt(String(row[2]).trim()) || 1 : 1;
            const inspector = row[7] ? String(row[7]).trim() : '';
            
            // ê³„ì•½ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
            if (!contractNumber) {
                continue;
            }
            
            // ì œí’ˆëª… í¬ë§·íŒ… (ìˆ˜ëŸ‰ì´ 2 ì´ìƒì´ë©´ "ì œí’ˆëª… NëŒ€" í˜•ì‹)
            let formattedProduct = productName;
            if (quantity > 1) {
                formattedProduct = `${productName} ${quantity}ëŒ€`;
            }
            
            // ê³„ì•½ë²ˆí˜¸ë³„ë¡œ ê·¸ë£¹í•‘
            if (!groupedByContract[contractNumber]) {
                groupedByContract[contractNumber] = {
                    contractNumber: contractNumber,
                    products: [],
                    inspector: inspector
                };
            }
            
            // ì¤‘ë³µ ì œí’ˆ ì²´í¬ í›„ ì¶”ê°€
            if (!groupedByContract[contractNumber].products.includes(formattedProduct)) {
                groupedByContract[contractNumber].products.push(formattedProduct);
            }
            
            // ê²€ìˆ˜ì ì •ë³´ ì—…ë°ì´íŠ¸ (ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°)
            if (inspector && !groupedByContract[contractNumber].inspector) {
                groupedByContract[contractNumber].inspector = inspector;
            }
        }
        
        // ê·¸ë£¹í•‘ëœ ë°ì´í„°ë¡œ í™•ì¸ì„œ ìƒì„±
        let receiptIndex = 0;
        Object.keys(groupedByContract).forEach(contractNumber => {
            const contractData = groupedByContract[contractNumber];
            const productList = contractData.products.join(', ');
            
            receiptsHTML += `
                <div class="receipt-page">
                    <div class="receipt" style="border: 3px solid #333; border-radius: 10px; padding: 30px; background: #fafafa;">
                        <h2 style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 30px; border-bottom: 3px solid #333; padding-bottom: 15px;">LG CNS ì¸ìˆ˜ í™•ì¸ì„œ</h2>
                        
                        <div class="receipt-info" style="margin-bottom: 40px;">
                            <div style="display: flex; margin-bottom: 15px; align-items: center;">
                                <strong style="width: 120px; font-size: 16px; font-weight: bold;">ê³„ì•½ë²ˆí˜¸:</strong>
                                <span class="value" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 16px;">${contractData.contractNumber}</span>
                            </div>
                            
                            <div style="display: flex; margin-bottom: 15px; align-items: center;">
                                <strong style="width: 120px; font-size: 16px; font-weight: bold;">ì œí’ˆëª…:</strong>
                                <span class="value" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 16px;">${productList}</span>
                            </div>
                            
                            <div style="display: flex; margin-bottom: 15px; align-items: center;">
                            <strong style="width: 120px; font-size: 16px; font-weight: bold;">ì‹œë¦¬ì–¼ë²ˆí˜¸:</strong>
                            <div class="barcode-input-wrapper" style="flex: 1;">
                            <input type="text" class="serial-input" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 16px;" placeholder="ì‹œë¦¬ì–¼ë²ˆí˜¸ ì…ë ¥ ë˜ëŠ” ìŠ¤ìº”">
                            <button class="barcode-scan-btn" onclick="openBarcodeScanner(this)">ğŸ“· ìŠ¤ìº”</button>
                            </div>
                            </div>
                            
                            <div style="display: flex; margin-bottom: 15px; align-items: center;">
                                <strong style="width: 120px; font-size: 16px; font-weight: bold;">ì‚¬ìš©ì:</strong>
                                <span class="value" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 16px;">${contractData.inspector}</span>
                            </div>
                            
                            <div style="display: flex; margin-bottom: 15px; align-items: center;">
                                <strong style="width: 120px; font-size: 16px; font-weight: bold;">ì¸ìˆ˜ì¼ì:</strong>
                                <span class="value" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 16px;">${currentDate}</span>
                            </div>
                        </div>
                        
                        <div class="signature-section" style="display: flex; gap: 30px; margin-top: 40px; justify-content: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; margin-bottom: 25px;">ì‚¬ìš©ì</div>
                                <div class="signature-box" onclick="openSignatureModal('user', ${receiptIndex})" data-type="user" data-index="${receiptIndex}">ì„œëª…</div>
                            </div>
                            
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; margin-bottom: 25px;">ëŒ€ë¦¬ì¸</div>
                                <div class="signature-box" onclick="openSignatureModal('agent', ${receiptIndex})" data-type="agent" data-index="${receiptIndex}">ì„œëª…</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            receiptIndex++;
        });
        
        console.log(`âœ… ${Object.keys(groupedByContract).length}ê°œ ê³„ì•½ë²ˆí˜¸ ì²˜ë¦¬ ì™„ë£Œ`);
    }
    
    receiptContainer.innerHTML = receiptsHTML;

    // ë§ˆì§€ë§‰ receipt-pageì— í´ë˜ìŠ¤ ì¶”ê°€
    const allPages = receiptContainer.querySelectorAll('.receipt-page');
    if (allPages.length > 0) {
        allPages[allPages.length - 1].classList.add('last-page');
    }

    receiptWrapper.classList.add('show');
    showMessage('âœ… í™•ì¸ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
}

      // ì¸ì‡„í•˜ê¸°
      function printReceipt() {
          if (!document.getElementById('receiptWrapper').classList.contains('show')) {
              showMessage('âŒ ë¨¼ì € í™•ì¸ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
              return;
          }
          
          window.print();
      }

// íŒŒì¼ ê·œì¹™ ë°•ìŠ¤ ë‚´ ë©”ì‹œì§€ í‘œì‹œ
function showFileMessage(message, type = 'success') {
    const messageBox = document.getElementById('fileMessage');
    const rulesElement = document.getElementById('fileRules');
    
    // ê·œì¹™ ìˆ¨ê¸°ê¸°
    rulesElement.style.display = 'none';
    
    // ë©”ì‹œì§€ ì„¤ì • ë° í‘œì‹œ
    messageBox.textContent = message;
    messageBox.className = `file-message ${type} show`;
    
    // 3ì´ˆ í›„ ê·œì¹™ ë‹¤ì‹œ í‘œì‹œ
    setTimeout(() => {
        messageBox.classList.remove('show');
        setTimeout(() => {
            messageBox.style.display = 'none';
            rulesElement.style.display = 'block';
        }, 300);
    }, 3000);
}

// í†µí•© ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ (í† ìŠ¤íŠ¸ ëŒ€ì‹  íŒŒì¼ ë©”ì‹œì§€ ì‚¬ìš©)
function showMessage(message, type = 'success') {
    // íŒŒì¼ ë©”ì‹œì§€ ë°•ìŠ¤ê°€ ìˆìœ¼ë©´ íŒŒì¼ ë©”ì‹œì§€ë¡œ, ì—†ìœ¼ë©´ í† ìŠ¤íŠ¸ë¡œ
    const fileMessageBox = document.getElementById('fileMessage');
    if (fileMessageBox) {
        showFileMessage(message, type);
    } else {
        showToast(message, type);
    }
}

// ê¸°ì¡´ í† ìŠ¤íŠ¸ í•¨ìˆ˜ëŠ” ë°±ì—…ìš©ìœ¼ë¡œ ìœ ì§€
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type}`;
    
    // í‘œì‹œ
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // ìˆ¨ê¸°ê¸°
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

      // ì„œëª… ê´€ë ¨ ë³€ìˆ˜
      let canvas, ctx;
      let isDrawing = false;
      let currentSignatureType = '';
      let currentSignatureIndex = 0;

// ì„œëª… ëª¨ë‹¬ ì—´ê¸°
function openSignatureModal(type, index) {
    console.log('ğŸ–Šï¸ ì„œëª… ëª¨ë‹¬ ì—´ê¸°:', type, index);
    
    currentSignatureType = type;
    currentSignatureIndex = index;
    
    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('signatureModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // ìƒˆ ëª¨ë‹¬ ìƒì„±
    const modalHTML = `
        <div class="signature-modal show" id="signatureModal">
            <div class="signature-popup">
                <div class="signature-header">
                    <h3 id="signatureTitle">${type === 'user' ? 'ì‚¬ìš©ì ì„œëª…' : 'ëŒ€ë¦¬ì¸ ì„œëª…'}</h3>
                    <p>ì•„ë˜ ì˜ì—­ì— ì†ê°€ë½ì´ë‚˜ íœìœ¼ë¡œ ì„œëª…í•´ì£¼ì„¸ìš”</p>
                </div>
                <canvas id="signatureCanvas" class="signature-canvas" width="500" height="200"></canvas>
                <div class="signature-controls">
                    <button class="signature-btn clear" onclick="clearSignature()">ğŸ—‘ï¸ ì§€ìš°ê¸°</button>
                    <button class="signature-btn save" onclick="saveSignature()">âœ… ì €ì¥</button>
                    <button class="signature-btn cancel" onclick="closeSignatureModal()">âŒ ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // ì ì‹œ ëŒ€ê¸° í›„ ìº”ë²„ìŠ¤ ì´ˆê¸°í™” (DOM ìƒì„± ì™„ë£Œ ëŒ€ê¸°)
    setTimeout(() => {
        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        canvas = document.getElementById('signatureCanvas');
        if (!canvas) {
            console.error('âŒ ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        ctx = canvas.getContext('2d');
        
        // ìº”ë²„ìŠ¤ ì„¤ì •
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        setupCanvasEvents();
        
        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ê¸°ì¡´ ì„œëª…ì´ ìˆë‹¤ë©´ í‘œì‹œ
        const existingSignature = getExistingSignature(type, index);
        if (existingSignature) {
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = existingSignature;
        }
        
        console.log('âœ… ì„œëª… ëª¨ë‹¬ ìƒì„± ì™„ë£Œ');
    }, 100);
}

      // ì„œëª… ëª¨ë‹¬ ë‹«ê¸°
      function closeSignatureModal() {
          const modal = document.getElementById('signatureModal');
          if (modal) {
              modal.classList.remove('show');
              
              // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
              removeCanvasEvents();
              
              // ëª¨ë‹¬ ì œê±°
              setTimeout(() => {
                  modal.remove();
              }, 300);
          }
      }

// ìº”ë²„ìŠ¤ ì´ë²¤íŠ¸ ì„¤ì •
function setupCanvasEvents() {
    if (!canvas) {
        console.error('âŒ ìº”ë²„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    console.log('ğŸ¯ ìº”ë²„ìŠ¤ ì´ë²¤íŠ¸ ì„¤ì • ì¤‘...');
    
    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    removeCanvasEvents();
    
    // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // í„°ì¹˜ ì´ë²¤íŠ¸ (passive: falseë¡œ preventDefault í—ˆìš©)
    canvas.addEventListener('touchstart', handleTouch, { passive: false });
    canvas.addEventListener('touchmove', handleTouch, { passive: false });
    canvas.addEventListener('touchend', handleTouch, { passive: false });
    
    console.log('âœ… ìº”ë²„ìŠ¤ ì´ë²¤íŠ¸ ì„¤ì • ì™„ë£Œ');
}

// ìº”ë²„ìŠ¤ ì´ë²¤íŠ¸ ì œê±°
function removeCanvasEvents() {
    if (canvas) {
        canvas.removeEventListener('mousedown', startDrawing);
        canvas.removeEventListener('mousemove', draw);
        canvas.removeEventListener('mouseup', stopDrawing);
        canvas.removeEventListener('mouseout', stopDrawing);
        canvas.removeEventListener('touchstart', handleTouch);
        canvas.removeEventListener('touchmove', handleTouch);
        canvas.removeEventListener('touchend', handleTouch);
    }
}

// ê·¸ë¦¬ê¸° ì‹œì‘
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    
    let x, y;
    if (e.touches && e.touches[0]) {
        // í„°ì¹˜ ì´ë²¤íŠ¸
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
    } else {
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
    }
    
    ctx.beginPath();
    ctx.moveTo(x, y);
}

// ê·¸ë¦¬ê¸°
function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    
    const rect = canvas.getBoundingClientRect();
    
    let x, y;
    if (e.touches && e.touches[0]) {
        // í„°ì¹˜ ì´ë²¤íŠ¸
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
    } else {
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
    }
    
    ctx.lineTo(x, y);
    ctx.stroke();
}

// ê·¸ë¦¬ê¸° ì¤‘ì§€
function stopDrawing(e) {
    if (isDrawing) {
        isDrawing = false;
        ctx.beginPath();
    }
}

// í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
function handleTouch(e) {
    e.preventDefault();
    
    if (e.type === 'touchstart') {
        startDrawing(e);
    } else if (e.type === 'touchmove') {
        draw(e);
    } else if (e.type === 'touchend') {
        stopDrawing(e);
    }
}

      // ì„œëª… ì§€ìš°ê¸° (ê°œì„ ëœ ë²„ì „)
function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // fillRect ì œê±° - íˆ¬ëª… ë°°ê²½ ìœ ì§€
}

      // ì„œëª… ì €ì¥
      function saveSignature() {
          const signatureData = canvas.toDataURL();
          
          // ë¹ˆ ì„œëª… ì²´í¬
          if (isCanvasEmpty()) {
              showMessage('âŒ ì„œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
              return;
          }
          
          // ì„œëª… ë°•ìŠ¤ì— ì ìš©
          const signatureBox = document.querySelector(`[data-type="${currentSignatureType}"][data-index="${currentSignatureIndex}"]`);
          if (signatureBox) {
              signatureBox.style.backgroundImage = `url(${signatureData})`;
              signatureBox.classList.add('signed');
              signatureBox.textContent = '';
          }
          
          // ì„œëª… ë°ì´í„° ì €ì¥
          saveSignatureData(currentSignatureType, currentSignatureIndex, signatureData);
          
          showMessage('âœ… ì„œëª…ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

          closeSignatureModal();
      }

      // ìº”ë²„ìŠ¤ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
      function isCanvasEmpty() {
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          
          for (let i = 0; i < data.length; i += 4) {
              if (data[i + 3] !== 0) { // ì•ŒíŒŒ ì±„ë„ì´ 0ì´ ì•„ë‹ˆë©´ ê·¸ë¦¼ì´ ìˆìŒ
                  return false;
              }
          }
          return true;
      }

      // ì„œëª… ë°ì´í„° ì €ì¥ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©)
      function saveSignatureData(type, index, data) {
          const key = `signature_${type}_${index}`;
          localStorage.setItem(key, data);
      }

      // ê¸°ì¡´ ì„œëª… ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      function getExistingSignature(type, index) {
          const key = `signature_${type}_${index}`;
          return localStorage.getItem(key);
      }
// ë°”ì½”ë“œ ìŠ¤ìº” ê´€ë ¨ ë³€ìˆ˜
let barcodeReader = null;
let currentStream = null;
let currentSerialInput = null;

// ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì—´ê¸°
function openBarcodeScanner(button) {
    // í˜„ì¬ ì…ë ¥ í•„ë“œ ì°¾ê¸°
    currentSerialInput = button.parentElement.querySelector('.serial-input');
    
    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('barcodeModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // ìƒˆ ëª¨ë‹¬ ìƒì„±
    const modalHTML = `
        <div class="barcode-modal show" id="barcodeModal">
            <div class="barcode-popup">
                <div class="barcode-header">
                    <h3>ğŸ“· ë°”ì½”ë“œ ìŠ¤ìº”</h3>
                    <p>ë°”ì½”ë“œë¥¼ ì¹´ë©”ë¼ì— ë¹„ì¶°ì£¼ì„¸ìš”</p>
                </div>
                <video id="barcodeVideo" class="barcode-video" autoplay playsinline></video>
                <div class="barcode-result" id="barcodeResult"></div>
                <div class="barcode-controls">
                    <button class="barcode-btn close" onclick="closeBarcodeScanner()">âŒ ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // ì¹´ë©”ë¼ ì‹œì‘
    startBarcodeScanner();
    
    // í‚¤ë³´ë“œ ì…ë ¥ ë¦¬ìŠ¤ë„ˆ (ë¸”ë£¨íˆ¬ìŠ¤ ìŠ¤ìºë„ˆìš©)
    document.addEventListener('keydown', handleBarcodeKeyboard);
}

// ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì‹œì‘
async function startBarcodeScanner() {
    try {
        console.log('ğŸ“· ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì‹œì‘...');
        
        // 1ë‹¨ê³„: ê¶Œí•œ ìƒíƒœ í™•ì¸
        const permissionState = await checkCameraPermission();
        
        if (permissionState === 'denied') {
            throw new Error('PERMISSION_DENIED');
        }
        
        // 2ë‹¨ê³„: ë¯¸ë””ì–´ ì¥ì¹˜ ì§€ì› ì—¬ë¶€ í™•ì¸
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('MEDIA_NOT_SUPPORTED');
        }
        
        // 3ë‹¨ê³„: ZXing ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
        if (typeof ZXing === 'undefined') {
            throw new Error('LIBRARY_NOT_LOADED');
        }
        
        // 4ë‹¨ê³„: ëª¨ë°”ì¼ ìµœì í™” ì¹´ë©”ë¼ ì„¤ì •
        const constraints = {
            video: {
                facingMode: 'environment', // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                width: { ideal: 1280, max: 1920 }, // ê³ í•´ìƒë„ë¡œ ë°”ì½”ë“œ ì¸ì‹ë¥  í–¥ìƒ
                height: { ideal: 720, max: 1080 },
                frameRate: { ideal: 30, max: 60 } // ë¶€ë“œëŸ¬ìš´ ìŠ¤ìº”
            }
        };
        
        // 5ë‹¨ê³„: ê¶Œí•œ ìš”ì²­ ë©”ì‹œì§€
        showMessage('ğŸ“· ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­í•©ë‹ˆë‹¤...', 'info');
        
        // 6ë‹¨ê³„: ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElement = document.getElementById('barcodeVideo');
        videoElement.srcObject = currentStream;
        
        // 7ë‹¨ê³„: ë°”ì½”ë“œ ë¦¬ë” ì´ˆê¸°í™”
        barcodeReader = new ZXing.BrowserMultiFormatReader();
        
        // 8ë‹¨ê³„: ë°”ì½”ë“œ ìŠ¤ìº” ì‹œì‘ (ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”)
        barcodeReader.decodeFromVideoDevice(null, 'barcodeVideo', (result, err) => {
            if (result) {
                const scannedText = result.getText();
                console.log('ğŸ“Š ë°”ì½”ë“œ ìŠ¤ìº” ì„±ê³µ:', scannedText);
                handleBarcodeResult(scannedText);
            } else if (err && err.name !== 'NotFoundException') {
                // NotFoundExceptionì€ ë°”ì½”ë“œë¥¼ ì°¾ì§€ ëª»í•œ ì •ìƒì ì¸ ìƒí™©
                console.log('ë°”ì½”ë“œ ìŠ¤ìº” ì¤‘...', err.name);
            }
        });
        
        showMessage('âœ… ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ë°”ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”.', 'success');
        
        // 9ë‹¨ê³„: ëª¨ë°”ì¼ìš© ì¶”ê°€ ì•ˆë‚´
        if (isMobileDevice()) {
            setTimeout(() => {
                showMessage('ğŸ’¡ ëª¨ë°”ì¼ íŒ: í™”ë©´ì„ ê°€ë¡œë¡œ ëŒë¦¬ê³  ë°”ì½”ë“œì— ê°€ê¹Œì´ ëŒ€ë³´ì„¸ìš”.', 'info');
            }, 3000);
        }
        
    } catch (error) {
        console.error('âŒ ì¹´ë©”ë¼ ì‹œì‘ ì˜¤ë¥˜:', error);
        
        // ì—ëŸ¬ íƒ€ì…ë³„ ë§ì¶¤ ë©”ì‹œì§€ ë° í•´ê²°ë°©ì•ˆ
        let errorTitle = 'âŒ ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        let errorDetails = '';
        let solutions = [];
        
        // ì—ëŸ¬ íƒ€ì… ë¶„ì„
        if (error.message === 'PERMISSION_DENIED' || error.name === 'NotAllowedError') {
            errorTitle = 'ğŸ“· ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
            errorDetails = 'ë°”ì½”ë“œ ìŠ¤ìº”ì„ ìœ„í•´ ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.';
            solutions = [
                'ğŸ”’ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì˜ ìë¬¼ì‡  ì•„ì´ì½˜ì„ í´ë¦­í•˜ì„¸ìš”',
                'ğŸ“· ì¹´ë©”ë¼ ê¶Œí•œì„ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”',
                'ğŸ”„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”'
            ];
        } else if (error.message === 'MEDIA_NOT_SUPPORTED') {
            errorTitle = 'ğŸ“± ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            errorDetails = 'ìµœì‹  ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ì‹œê±°ë‚˜ ë‹¤ë¥¸ ë°©ë²•ì„ ì´ìš©í•´ì£¼ì„¸ìš”.';
            solutions = [
                'ğŸŒ Chrome, Safari, Firefox ë“± ìµœì‹  ë¸Œë¼ìš°ì € ì‚¬ìš©',
                'ğŸ“± ëª¨ë°”ì¼ ì•±ìœ¼ë¡œ ì ‘ì†í•´ë³´ì„¸ìš”'
            ];
        } else if (error.message === 'LIBRARY_NOT_LOADED') {
            errorTitle = 'ğŸ“š ë°”ì½”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨';
            errorDetails = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
            solutions = [
                'ğŸŒ ì¸í„°ë„· ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”',
                'ğŸ”„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”'
            ];
        } else if (error.name === 'NotFoundError') {
            errorTitle = 'ğŸ“· ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            errorDetails = 'ì¹´ë©”ë¼ê°€ ë‹¤ë¥¸ ì•±ì—ì„œ ì‚¬ìš© ì¤‘ì´ê±°ë‚˜ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            solutions = [
                'ğŸ“± ë‹¤ë¥¸ ì¹´ë©”ë¼ ì•±ì„ ì¢…ë£Œí•´ì£¼ì„¸ìš”',
                'ğŸ”Œ ì™¸ì¥ ì¹´ë©”ë¼ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”'
            ];
        } else if (error.name === 'NotReadableError') {
            errorTitle = 'ğŸ“· ì¹´ë©”ë¼ê°€ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.';
            errorDetails = 'ë‹¤ë¥¸ ì•±ì´ë‚˜ íƒ­ì—ì„œ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.';
            solutions = [
                'ğŸ“± ë‹¤ë¥¸ ì¹´ë©”ë¼ ì•±ì„ ëª¨ë‘ ì¢…ë£Œí•˜ì„¸ìš”',
                'ğŸŒ ë‹¤ë¥¸ ë¸Œë¼ìš°ì € íƒ­ì„ í™•ì¸í•˜ì„¸ìš”'
            ];
        } else if (error.name === 'OverconstrainedError') {
            errorTitle = 'ğŸ“· ì¹´ë©”ë¼ ì„¤ì • ì˜¤ë¥˜';
            errorDetails = 'ìš”ì²­í•œ ì¹´ë©”ë¼ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            solutions = [
                'ğŸ“± ë‹¤ë¥¸ í•´ìƒë„ë¡œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”'
            ];
        }
        
        // ìƒì„¸ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        const resultDiv = document.getElementById('barcodeResult');
        resultDiv.innerHTML = `
            <div style="color: #721c24; background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 8px; margin: 15px 0; line-height: 1.6;">
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                    ${errorTitle}
                </div>
                <div style="margin-bottom: 15px; font-size: 14px;">
                    ${errorDetails}
                </div>
                
                ${solutions.length > 0 ? `
                <div style="margin-bottom: 15px;">
                    <strong style="font-size: 16px;">ğŸ”§ í•´ê²° ë°©ë²•:</strong><br>
                    ${solutions.map(s => `<div style="margin: 8px 0; padding-left: 10px;">â€¢ ${s}</div>`).join('')}
                </div>
                ` : ''}
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <strong style="color: #856404; font-size: 16px;">ğŸ”„ ëŒ€ì•ˆ ë°©ë²•:</strong><br>
                    <div style="color: #856404; margin-top: 8px;">
                        â€¢ ğŸ“¡ <strong>ë¸”ë£¨íˆ¬ìŠ¤ ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</strong> ì‚¬ìš©<br>
                        â€¢ âŒ¨ï¸ <strong>ì‹œë¦¬ì–¼ë²ˆí˜¸ ì§ì ‘ ì…ë ¥</strong><br>
                        â€¢ ğŸ’» <strong>PCì—ì„œ ì ‘ì†</strong>í•˜ì—¬ ì‚¬ìš©<br>
                        â€¢ ğŸ“± <strong>ë‹¤ë¥¸ ë¸Œë¼ìš°ì €</strong>ë¡œ ì‹œë„
                    </div>
                </div>
            </div>
        `;
        resultDiv.style.display = 'block';
        
        // ê°„ë‹¨í•œ ì•Œë¦¼ ë©”ì‹œì§€
        showMessage(errorTitle + ' ëŒ€ì•ˆ ë°©ë²•ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
    }
}

// ë°”ì½”ë“œ ê²°ê³¼ ì²˜ë¦¬
function handleBarcodeResult(scannedText) {
    if (currentSerialInput && scannedText.trim()) {
        currentSerialInput.value = scannedText.trim();
        
        // ê²°ê³¼ í‘œì‹œ
        const resultDiv = document.getElementById('barcodeResult');
        resultDiv.innerHTML = `âœ… ìŠ¤ìº” ì™„ë£Œ: ${scannedText}`;
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#d4edda';
        resultDiv.style.color = '#155724';
        
        showMessage('âœ… ë°”ì½”ë“œ ìŠ¤ìº” ì™„ë£Œ!', 'success');
        
        // 2ì´ˆ í›„ ëª¨ë‹¬ ìë™ ë‹«ê¸°
        setTimeout(() => {
            closeBarcodeScanner();
        }, 2000);
    }
}

// í‚¤ë³´ë“œ ì…ë ¥ ì²˜ë¦¬ (ë¸”ë£¨íˆ¬ìŠ¤ ìŠ¤ìºë„ˆìš©)
let barcodeBuffer = '';
let barcodeTimeout = null;

function handleBarcodeKeyboard(event) {
    // ëª¨ë‹¬ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ ì²˜ë¦¬
    if (!document.getElementById('barcodeModal')) return;
    
    // Enter í‚¤ë¡œ ë°”ì½”ë“œ ì…ë ¥ ì™„ë£Œ
    if (event.key === 'Enter') {
        event.preventDefault();
        if (barcodeBuffer.trim()) {
            handleBarcodeResult(barcodeBuffer);
            barcodeBuffer = '';
        }
        return;
    }
    
    // ì¼ë°˜ ë¬¸ì ì…ë ¥
    if (event.key.length === 1) {
        event.preventDefault();
        barcodeBuffer += event.key;
        
        // íƒ€ì„ì•„ì›ƒ ë¦¬ì…‹ (ë¹ ë¥¸ ì—°ì† ì…ë ¥ ê°ì§€)
        clearTimeout(barcodeTimeout);
        barcodeTimeout = setTimeout(() => {
            if (barcodeBuffer.trim()) {
                handleBarcodeResult(barcodeBuffer);
                barcodeBuffer = '';
            }
        }, 100); // 100ms ëŒ€ê¸°
    }
}

// ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ë‹«ê¸°
function closeBarcodeScanner() {
    // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì •ì§€
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
    }
    
    // ë°”ì½”ë“œ ë¦¬ë” ì •ì§€
    if (barcodeReader) {
        barcodeReader.reset();
        barcodeReader = null;
    }
    
    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
    document.removeEventListener('keydown', handleBarcodeKeyboard);
    
    // ëª¨ë‹¬ ì œê±°
    const modal = document.getElementById('barcodeModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
    
    // ë³€ìˆ˜ ì´ˆê¸°í™”
    currentSerialInput = null;
    barcodeBuffer = '';
    clearTimeout(barcodeTimeout);
}
  </script>
  <script>
    // Service Worker ë“±ë¡
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed'));
      });
    }
  </script>
</body>
</html>
