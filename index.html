<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LG CNS 통합 물품관리 시스템</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      body { 
          font-family: 'Malgun Gothic', sans-serif; 
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          color: white;
      }
      
      .container { 
          max-width: 1200px; 
          margin: 0 auto; 
          padding: 20px;
      }

      h1 { 
          text-align: center;
          margin-bottom: 30px; 
          font-size: 28px; 
          font-weight: bold;
          color: #fff;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
          background: rgba(255,255,255,0.1);
          padding: 20px;
          border-radius: 15px;
          backdrop-filter: blur(10px);
      }

      .mode-tabs {
          display: flex;
          justify-content: center;
          margin-bottom: 30px;
          gap: 10px;
      }

      .mode-tab {
          padding: 15px 30px;
          background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
          color: rgba(255,255,255,0.8);
          border: 2px solid rgba(255,255,255,0.2);
          border-radius: 30px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 700;
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          position: relative;
          overflow: hidden;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      }

      .mode-tab:hover {
          transform: translateY(-3px);
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          border-color: rgba(255,255,255,0.4);
      }

      .mode-tab.active {
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          color: white;
          border-color: rgba(255,255,255,0.6);
          box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
          transform: translateY(-2px);
      }

      .upload-section { 
          text-align: center; 
          margin-bottom: 30px; 
          padding: 20px; 
          background: rgba(255,255,255,0.1);
          border-radius: 15px;
          backdrop-filter: blur(10px);
      }
      
      .file-input-wrapper { 
          position: relative; 
          display: inline-block; 
          margin-bottom: 15px;
      }
      
      .file-input-wrapper input[type=file] { 
          position: absolute; 
          opacity: 0; 
          width: 100%; 
          height: 100%; 
          cursor: pointer; 
      }
      
      .file-input-label { 
          display: inline-block; 
          padding: 12px 25px; 
          background: rgba(255,255,255,0.2);
          color: white; 
          border-radius: 25px; 
          cursor: pointer; 
          font-size: 16px; 
          transition: all 0.3s ease;
          border: 2px solid rgba(255,255,255,0.3);
      }
      
      .file-input-label:hover { 
          background: rgba(255,255,255,0.3);
      }

      .upload-info {
          margin-top: 10px;
          font-size: 14px;
          color: rgba(255,255,255,0.8);
      }

      .file-rules {
          margin-top: 15px;
          padding: 15px;
          background: rgba(255,255,255,0.1);
          border-radius: 10px;
          border-left: 4px solid #ffc107;
          text-align: left;
          font-size: 13px;
          line-height: 1.6;
      }

      .file-rules h4 {
          color: #ffc107;
          margin-bottom: 8px;
          font-size: 14px;
      }

      .file-rules ul {
          list-style-type: none;
          padding-left: 0;
      }

      .file-rules li {
          margin-bottom: 5px;
          padding-left: 20px;
          position: relative;
      }

      .file-rules li:before {
          content: "•";
          color: #ffc107;
          position: absolute;
          left: 0;
      }

      .controls { 
          display: flex; 
          justify-content: center; 
          align-items: center; 
          gap: 20px; 
          margin-bottom: 25px; 
          flex-wrap: wrap;
      }
      
      .date-display {
          padding: 15px 25px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border-radius: 30px;
          font-size: 16px;
          font-weight: 700;
          backdrop-filter: blur(10px);
          border: 3px solid rgba(255,255,255,0.3);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
          text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      }

      .btn { 
          padding: 15px 30px; 
          border: none; 
          border-radius: 30px; 
          cursor: pointer; 
          font-size: 16px; 
          font-weight: 700;
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          backdrop-filter: blur(10px);
          position: relative;
          overflow: hidden;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
          border: 2px solid rgba(255,255,255,0.3);
      }

      .btn-primary { 
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white; 
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary { 
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
          color: white; 
          box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
      }

      .btn:hover {
          transform: translateY(-4px) scale(1.05);
          box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      }

      .receipt-wrapper {
          display: none;
          background: white;
          color: black;
          padding: 0px;
          margin-top: 30px;
          border-radius: 15px;
          width: 100%;
      }

      .receipt-wrapper.show {
          display: block;
      }

      .receipt-page { 
          width: 100%; 
          margin: 20px auto; 
          padding: 15mm; 
          background: white; 
          box-shadow: 0 15px 50px rgba(0,0,0,0.3);
          border-radius: 15px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
      }

      .receipt { 
          border: 2px solid #333; 
          padding: 20px; 
          margin-bottom: 5mm;
          border-radius: 8px;
          background: #fafafa;
          width: 100%;
          max-width: none;
      }

      .receipt h2 { 
          text-align: center; 
          margin-bottom: 25px; 
          font-size: 24px; 
          color: #333;
          border-bottom: 3px solid #667eea; 
          padding-bottom: 12px; 
          font-weight: 700;
      }

      .receipt-info { 
          margin-bottom: 30px; 
      }
      
      .cut-line::before { 
          content: "✂️ 절취선"; 
          position: absolute; 
          left: 50%; 
          top: -12px; 
          transform: translateX(-50%); 
          background: white; 
          padding: 0 20px; 
          color: #667eea;
          font-weight: 600;
          font-size: 14px;
      }

      .toast {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          background: #28a745;
          color: white;
          border-radius: 8px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          z-index: 10000;
          opacity: 0;
          transform: translateX(100%);
          transition: all 0.3s ease;
          font-weight: 600;
          max-width: 350px;
          word-wrap: break-word;
      }

      .toast.show {
          opacity: 1;
          transform: translateX(0);
      }

      .toast.error {
          background: #dc3545;
      }

      @media print {
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    
    body {
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
        font-family: 'Malgun Gothic', sans-serif !important;
    }
    
    .container > *:not(.receipt-wrapper) {
        display: none !important;
    }
    
    .receipt-wrapper {
        display: block !important;
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
    }
    
    .receipt-page {
        width: 210mm !important;
        height: 297mm !important;
        margin: 0 !important;
        padding: 15mm !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        background: white !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start !important;
        page-break-after: always !important;
        page-break-inside: avoid !important;
    }

    .receipt-page:last-child,
    .receipt-page.last-page {
        page-break-after: avoid !important;
    }
    
    .receipt {
        border: 2px solid #333 !important;
        padding: 15px !important;
        margin-bottom: 8mm !important;
        border-radius: 8px !important;
        background: #fafafa !important;
        width: 100% !important;
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    .receipt h2 {
        text-align: center !important;
        margin-bottom: 20px !important;
        font-size: 20px !important;
        color: #333 !important;
        border-bottom: 3px solid #667eea !important;
        padding-bottom: 10px !important;
        font-weight: 700 !important;
    }
    
    .receipt-info {
        margin-bottom: 25px !important;
        flex: 1 !important;
    }
    
    .receipt-info p {
        margin-bottom: 12px !important;
        font-size: 14px !important;
        display: flex !important;
        align-items: flex-start !important;
        gap: 8px !important;
    }
    
}

.cut-line {
    border-top: 2px dashed #667eea !important;
    margin: 1mm auto 8mm auto !important;
    position: relative !important;
    text-align: center !important;
    width: 100% !important;
}
    
    .cut-line::before {
        content: "✂️ 절취선" !important;
        position: absolute !important;
        left: 50% !important;
        top: -10px !important;
        transform: translateX(-50%) !important;
        background: white !important;
        padding: 0 15px !important;
        color: #667eea !important;
        font-weight: 600 !important;
        font-size: 12px !important;
    }

/* 회수확인서 전용 스타일 */
.receipt-info p {
    display: flex;
    margin-bottom: 15px;
    align-items: center;
    font-size: 16px;
}

.receipt-info p strong {
    width: 140px;
    font-weight: bold;
    color: #333;
    background: #f8f9fa;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-right: none;
    border-radius: 4px 0 0 4px;
}

.receipt-info p .value {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 0 4px 4px 0;
    min-height: 20px;
}

.signature-section {
    margin-top: 40px;
    padding: 20px;
    border-top: 2px solid #eee;
}

.signature-row {
    display: flex;
    justify-content: center;
    gap: 40px;
    align-items: flex-end;
    margin-top: 20px;
}

.signature-group {
    display: flex;
    align-items: flex-end;
    gap: 15px;
}

.signature-title {
    font-size: 18px;
    font-weight: bold;
    color: #333;
}

.signature-line {
    width: 150px;
    height: 1px;
    border-bottom: 2px solid #333;
    margin: 0 10px;
    align-self: flex-end;
    margin-bottom: 2px;
}

      /* 서명 모달 스타일 - 여기부터 추가 */
      .signature-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10000;
    display: none;
    justify-content: center;
    align-items: center;
}

.signature-modal.show {
    display: flex !important;
}

      .signature-popup {
          background: white;
          border-radius: 15px;
          padding: 30px;
          max-width: 90vw;
          max-height: 90vh;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          position: relative;
      }

      .signature-header {
          text-align: center;
          margin-bottom: 20px;
          padding-bottom: 15px;
          border-bottom: 2px solid #667eea;
      }

      .signature-header h3 {
          color: #333;
          font-size: 24px;
          font-weight: 700;
          margin-bottom: 10px;
      }

      .signature-header p {
          color: #666;
          font-size: 16px;
      }

      .signature-canvas {
          border: 3px solid #667eea;
          border-radius: 10px;
          cursor: crosshair;
          touch-action: none;
          background: white;
          display: block;
          margin: 0 auto;
      }

      .signature-controls {
          display: flex;
          justify-content: center;
          gap: 15px;
          margin-top: 20px;
          flex-wrap: wrap;
      }

      .signature-btn {
          padding: 12px 25px;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          transition: all 0.3s ease;
          min-width: 120px;
      }

      .signature-btn.clear {
          background: #dc3545;
          color: white;
      }

      .signature-btn.clear:hover {
          background: #c82333;
          transform: translateY(-2px);
      }

      .signature-btn.save {
          background: #28a745;
          color: white;
      }

      .signature-btn.save:hover {
          background: #218838;
          transform: translateY(-2px);
      }

      .signature-btn.cancel {
          background: #6c757d;
          color: white;
      }

      .signature-btn.cancel:hover {
          background: #5a6268;
          transform: translateY(-2px);
      }

      .signature-box {
          border: 2px solid #333;
          height: 80px;
          width: 250px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #999;
          font-size: 16px;
          background: white;
          cursor: pointer;
          transition: all 0.3s ease;
          border-radius: 5px;
          position: relative;
          overflow: hidden;
      }

      .signature-box:hover {
          border-color: #667eea;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
      }

      .signature-box.signed {
          background-size: contain;
          background-repeat: no-repeat;
          background-position: center;
          color: transparent;
          border-color: #28a745;
      }

      .signature-box.signed::after {
          content: "✓ 서명완료";
          position: absolute;
          bottom: 5px;
          right: 5px;
          background: #28a745;
          color: white;
          padding: 2px 6px;
          border-radius: 3px;
          font-size: 10px;
          font-weight: 600;
      }

      @media print {
          .signature-modal {
              display: none !important;
          }
          
          .signature-box.signed::after {
              display: none !important;
          }
/* 인쇄용 서명 정렬 최적화 */
@media print {
    .signature-section {
        margin-top: 30px !important;
        padding: 15px !important;
        border-top: 2px solid #eee !important;
    }
    
    .signature-row {
        display: flex !important;
        justify-content: center !important;
        gap: 50px !important;
        align-items: flex-end !important;
        margin-top: 15px !important;
        width: 100% !important;
    }
    
    .signature-group {
        display: flex !important;
        align-items: flex-end !important;
        gap: 10px !important;
        white-space: nowrap !important;
    }
    
    .signature-title {
        font-size: 14px !important;
        font-weight: bold !important;
        color: #333 !important;
        margin-bottom: 2px !important;
    }
    
    .signature-line {
        width: 100px !important;
        height: 1px !important;
        border-bottom: 2px solid #333 !important;
        margin: 0 5px !important;
        margin-bottom: 2px !important;
        flex-shrink: 0 !important;
    }
}
      }
      /* 서명 모달 스타일 - 여기까지 추가 */
  </style>
</head>
<body>
  <div class="container">
      <h1>🏢 LG CNS 통합 물품관리 시스템</h1>
      
      <div class="mode-tabs">
          <div class="mode-tab active" data-mode="receipt">📤 회수확인서</div>
          <div class="mode-tab" data-mode="delivery">📥 인수확인서</div>
      </div>

      <div class="upload-section">
          <h3>📊 엑셀 파일 업로드</h3>
          <div class="file-input-wrapper">
              <input type="file" id="fileInput" accept=".xlsx,.xls" />
              <label for="fileInput" class="file-input-label">📁 파일 선택</label>
          </div>
          <div class="upload-info">엑셀 파일을 선택하면 자동으로 처리됩니다.</div>
          
          <div class="file-rules">
              <h4>📋 파일 업로드 규칙</h4>
              <ul id="fileRules">
                  <li>회수확인서 모드: "회수" 관련 파일만 업로드 가능</li>
                  <li>인수확인서 모드: "납품" 또는 "인수" 관련 파일만 업로드 가능</li>
                  <li>파일명에 해당 키워드가 포함되어야 합니다</li>
              </ul>
          </div>
      </div>

      <div class="controls">
          <div class="date-display">
              <span>📅 </span>
              <span id="currentDate">로딩중...</span>
          </div>
          <button class="btn btn-primary" onclick="generateReceipt()">📋 확인서 생성</button>
          <button class="btn btn-secondary" onclick="printReceipt()">🖨️ 인쇄하기</button>
      </div>

      <div class="receipt-wrapper" id="receiptWrapper">
          <div id="receiptContainer"></div>
      </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
      // 전역 변수
      let currentMode = 'receipt';
      let excelData = [];

      // 파일명 검증 규칙
      const fileValidationRules = {
          receipt: {
              allowed: ['회수', '회수리스트', '회수목록', '반납'],
              blocked: ['납품', '자산납품', '인수', '배송', '전달'],
              message: '회수확인서 모드에서는 "회수" 관련 파일만 업로드할 수 있습니다.'
          },
          delivery: {
              allowed: ['납품', '자산납품', '인수', '배송', '전달', '인수리스트'],
              blocked: ['회수', '회수리스트', '반납'],
              message: '인수확인서 모드에서는 "납품" 또는 "인수" 관련 파일만 업로드할 수 있습니다.'
          }
      };

      // DOM이 로드되면 실행
      document.addEventListener('DOMContentLoaded', function() {
          console.log('🚀 시스템 초기화 시작');
          
          // 날짜 업데이트 시작
          updateCurrentDate();
          setInterval(updateCurrentDate, 1000);
          
          // 파일 규칙 업데이트
          updateFileRules();
          
          // 이벤트 리스너 등록
          setupEventListeners();
          
          // 초기화 완료 알림
          setTimeout(() => {
              showToast('✅ 시스템이 준비되었습니다!');
          }, 500);
      });

      // 이벤트 리스너 설정
      function setupEventListeners() {
          // 모드 탭 클릭 이벤트
          document.querySelectorAll('.mode-tab').forEach(tab => {
              tab.addEventListener('click', function() {
                  const mode = this.getAttribute('data-mode');
                  switchMode(mode);
              });
          });

          // 파일 업로드 이벤트
          const fileInput = document.getElementById('fileInput');
          fileInput.addEventListener('change', handleFileUpload);
          
          console.log('✅ 이벤트 리스너 등록 완료');
      }

      // 현재 날짜 업데이트
      function updateCurrentDate() {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');
          
          const dateString = `${year}년 ${month}월 ${day}일 ${hours}:${minutes}:${seconds}`;
          
          const dateElement = document.getElementById('currentDate');
          if (dateElement) {
              dateElement.textContent = dateString;
          }
      }

      // 파일 규칙 업데이트
      function updateFileRules() {
          const rulesElement = document.getElementById('fileRules');
          const rules = fileValidationRules[currentMode];
          
          rulesElement.innerHTML = `
              <li><strong>${currentMode === 'receipt' ? '회수확인서' : '인수확인서'} 모드</strong></li>
              <li>허용 키워드: ${rules.allowed.join(', ')}</li>
              <li>차단 키워드: ${rules.blocked.join(', ')}</li>
              <li>파일명에 허용 키워드가 포함되어야 합니다</li>
          `;
      }

      // 파일명 검증
      function validateFileName(fileName) {
          const rules = fileValidationRules[currentMode];
          const lowerFileName = fileName.toLowerCase();
          
          // 차단된 키워드 확인
          for (let blocked of rules.blocked) {
              if (lowerFileName.includes(blocked.toLowerCase())) {
                  return {
                      valid: false,
                      message: `❌ "${blocked}" 키워드가 포함된 파일은 현재 모드에서 업로드할 수 없습니다.`
                  };
              }
          }
          
          // 허용된 키워드 확인
          let hasAllowedKeyword = false;
          for (let allowed of rules.allowed) {
              if (lowerFileName.includes(allowed.toLowerCase())) {
                  hasAllowedKeyword = true;
                  break;
              }
          }
          
          if (!hasAllowedKeyword) {
              return {
                  valid: false,
                  message: `❌ 허용된 키워드(${rules.allowed.join(', ')})가 파일명에 포함되지 않았습니다.`
              };
          }
          
          return { valid: true, message: '✅ 파일명 검증 통과' };
      }

      // 모드 전환
      function switchMode(mode) {
          console.log('🔄 모드 전환:', mode);
          currentMode = mode;
          
          // 탭 활성화 상태 변경
          document.querySelectorAll('.mode-tab').forEach(tab => {
              tab.classList.remove('active');
          });
          document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

          // 파일 규칙 업데이트
          updateFileRules();

          // 기존 데이터 초기화
          excelData = [];
          document.getElementById('receiptWrapper').classList.remove('show');
          document.getElementById('fileInput').value = '';

          const modeText = mode === 'receipt' ? '회수확인서' : '인수확인서';
          showToast(`${modeText} 모드로 전환되었습니다.`);
      }

      // 파일 업로드 처리
      function handleFileUpload(event) {
          console.log('📁 파일 업로드 시작');
          
          const file = event.target.files[0];
          if (!file) return;

          console.log('선택된 파일:', file.name);
          
          // 파일 타입 검증
          if (!file.name.match(/\.(xlsx|xls)$/i)) {
              showToast('❌ 엑셀 파일(.xlsx, .xls)만 업로드 가능합니다.', 'error');
              event.target.value = '';
              return;
          }
          
          // 파일명 검증
          const validation = validateFileName(file.name);
          if (!validation.valid) {
              showToast(validation.message, 'error');
              event.target.value = '';
              return;
          }

          showToast('📄 파일 검증 완료. 읽는 중...', 'success');

          const reader = new FileReader();
          
          reader.onload = function(e) {
              try {
                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, { type: 'array' });
                  const firstSheetName = workbook.SheetNames[0];
                  const worksheet = workbook.Sheets[firstSheetName];
                  
                  excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                  
                  if (excelData.length > 1) {
                      const dataRows = excelData.length - 1;
                      showToast(`✅ 파일 로드 성공! ${dataRows}개 항목`);
                  } else {
                      showToast('❌ 데이터가 없습니다.', 'error');
                  }
                  
              } catch (error) {
                  console.error('파일 파싱 오류:', error);
                  showToast('❌ 파일 읽기 오류', 'error');
              }
          };
          
          reader.readAsArrayBuffer(file);
      }

// 확인서 생성 함수에서 인수확인서 부분만 수정
function generateReceipt() {
    if (excelData.length === 0) {
        showToast('❌ 먼저 엑셀 파일을 업로드해주세요.', 'error');
        return;
    }

    const receiptWrapper = document.getElementById('receiptWrapper');
    const receiptContainer = document.getElementById('receiptContainer');
    
    let receiptsHTML = '';
    const currentDate = new Date().toLocaleDateString('ko-KR');
    
    if (currentMode === 'receipt') {
        // 기존 회수확인서 로직 유지 (수정하지 않음)
        const groupedData = {};
        
        for (let i = 5; i < excelData.length; i++) {
            const row = excelData[i];
            if (row && row.length > 0) {
                const assetNumber = row[0] ? String(row[0]).trim() : '';
                
                if (!assetNumber || !/^\d/.test(assetNumber)) {
                    continue;
                }
                
                const collectionNumber = row[1] ? String(row[1]).trim() : '';
                if (!collectionNumber) {
                    continue;
                }
                
                const assetType = row[2] ? String(row[2]).trim() : '';
                const modelName = row[3] ? String(row[3]).trim() : '';
                const contactPerson = row[9] ? String(row[9]).trim() : '';
                const phoneNumber = row[10] ? String(row[10]).trim() : '';
                
                if (!groupedData[collectionNumber]) {
                    groupedData[collectionNumber] = {
                        assetNumbers: [],
                        assetItems: [],
                        contactPerson: contactPerson,
                        phoneNumber: phoneNumber
                    };
                }
                
                if (!groupedData[collectionNumber].assetNumbers.includes(assetNumber)) {
                    groupedData[collectionNumber].assetNumbers.push(assetNumber);
                }
                
                const assetItem = `${assetType} ${modelName}`.trim();
                if (assetItem && !groupedData[collectionNumber].assetItems.includes(assetItem)) {
                    groupedData[collectionNumber].assetItems.push(assetItem);
                }
            }
        }
        
        Object.keys(groupedData).forEach(collectionNumber => {
            const data = groupedData[collectionNumber];
            const assetNumbers = data.assetNumbers.join(', ');
            const assetList = data.assetItems.join(', ');
            const returnPersonInfo = `${data.contactPerson} ${data.phoneNumber}`.trim();
            
            receiptsHTML += `
                <div class="receipt-page">
                    <div class="receipt">
                        <h2>LG CNS 회수 확인서(회수자)</h2>
                        <div class="receipt-info">
                            <p><strong>자산번호</strong><span class="value">${assetNumbers}</span></p>
                            <p><strong>회수코드</strong><span class="value">${collectionNumber}</span></p>
                            <p><strong>반납자산목록</strong><span class="value">${assetList}</span></p>
                            <p><strong>반납자정보</strong><span class="value">${returnPersonInfo}</span></p>
                            <p><strong>회수일자</strong><span class="value">${currentDate}</span></p>
                        </div>
                        <div class="signature-section">
                <div class="signature-row" style="justify-content: center !important;">
                    <div class="signature-group">
                        <span class="signature-title">회수자 :</span>
                        <div class="signature-line"></div>
                        <span style="margin-left: 10px;">인</span>
                    </div>
                    <div class="signature-group" style="margin-left: 10px;">
                        <span class="signature-title">반납자 :</span>
                        <div class="signature-line"></div>
                        <span style="margin-left: 10px;">인</span>
                    </div>
                            </div>
                        </div>
                    </div>
                    <div class="cut-line"></div>
                    <div class="receipt">
                        <h2>LG CNS 회수 확인서(반납자)</h2>
                        <div class="receipt-info">
                            <p><strong>자산번호</strong><span class="value">${assetNumbers}</span></p>
                            <p><strong>회수코드</strong><span class="value">${collectionNumber}</span></p>
                            <p><strong>반납자산목록</strong><span class="value">${assetList}</span></p>
                            <p><strong>반납자정보</strong><span class="value">${returnPersonInfo}</span></p>
                            <p><strong>회수일자</strong><span class="value">${currentDate}</span></p>
                        </div>
                        <div class="signature-section">
                            <div class="signature-row" style="justify-content: center !important;">
                                <div class="signature-group">
                                    <span class="signature-title">회수자 :</span>
                                    <div class="signature-line"></div>
                                    <span style="margin-left: 10px;">인</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
    } else if (currentMode === 'delivery') {
        // 새로운 인수확인서 로직 (이미지 양식에 맞춤)
        for (let i = 1; i < excelData.length; i++) {
            const row = excelData[i];
            if (row && row.length > 0 && row.some(cell => cell)) {
                // 엑셀 데이터에서 필요한 정보 추출
                const contractNumber = row[0] ? String(row[0]).trim() : '';
const productName = row[1] ? String(row[1]).trim() : '';
const serialNumber = row[2] ? String(row[2]).trim() : '';
const userName = row[3] ? String(row[3]).trim() : '';
const deliveryLocation = row[4] ? String(row[4]).trim() : '';
                
                receiptsHTML += `
                    <div class="receipt-page">
                        <div class="receipt" style="border: 3px solid #333; border-radius: 10px; padding: 30px; background: #fafafa;">
                            <h2 style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 30px; border-bottom: 3px solid #333; padding-bottom: 15px;">LG CNS 인수 확인서</h2>
                            
                            <div class="receipt-info" style="margin-bottom: 40px;">
                                <div style="display: flex; margin-bottom: 15px; align-items: center;">
                                    <strong style="width: 120px; font-size: 16px; font-weight: bold;">계약번호:</strong>
                                    <span class="value" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 16px;">${contractNumber}</span>
                                </div>
                                
                                <div style="display: flex; margin-bottom: 15px; align-items: center;">
                                    <strong style="width: 120px; font-size: 16px; font-weight: bold;">제품명:</strong>
                                    <span class="value" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 16px;">${productName}</span>
                                </div>
                                
                                <div style="display: flex; margin-bottom: 15px; align-items: center;">
                                    <strong style="width: 120px; font-size: 16px; font-weight: bold;">시리얼번호:</strong>
                                    <span class="value" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; font-size: 16px; color: #666;">${serialNumber}</span>
                                </div>
                                
                                <div style="display: flex; margin-bottom: 15px; align-items: center;">
                                    <strong style="width: 120px; font-size: 16px; font-weight: bold;">사용자:</strong>
                                    <span class="value" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 16px;">${userName}</span>
                                </div>
                                
                                <div style="display: flex; margin-bottom: 15px; align-items: center;">
                                    <strong style="width: 120px; font-size: 16px; font-weight: bold;">인수일자:</strong>
                                    <span class="value" style="flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; font-size: 16px;">${currentDate}</span>
                                </div>
                            </div>
                            
                            <div class="signature-section" style="display: flex; gap: 30px; margin-top: 40px; justify-content: center;">
    <div style="text-align: center;">
        <div style="font-size: 20px; font-weight: bold; margin-bottom: 25px;">사용자</div>
        <div class="signature-box" onclick="openSignatureModal('user', ${i})" data-type="user" data-index="${i}">서명</div>
    </div>
    
    <div style="text-align: center;">
        <div style="font-size: 20px; font-weight: bold; margin-bottom: 25px;">대리인</div>
        <div class="signature-box" onclick="openSignatureModal('agent', ${i})" data-type="agent" data-index="${i}">서명</div>
    </div>
</div>
                        </div>
                    </div>
                `;
            }
        }
    }
    
    receiptContainer.innerHTML = receiptsHTML;

    // 마지막 receipt-page에 클래스 추가
    const allPages = receiptContainer.querySelectorAll('.receipt-page');
    if (allPages.length > 0) {
        allPages[allPages.length - 1].classList.add('last-page');
    }

    receiptWrapper.classList.add('show');
    showToast('✅ 확인서가 생성되었습니다!');
}

      // 인쇄하기
      function printReceipt() {
          if (!document.getElementById('receiptWrapper').classList.contains('show')) {
              showToast('❌ 먼저 확인서를 생성해주세요.', 'error');
              return;
          }
          
          window.print();
      }

      // 토스트 메시지 표시
      function showToast(message, type = 'success') {
          const toast = document.getElementById('toast');
          toast.textContent = message;
          toast.className = `toast ${type}`;
          
          // 표시
          setTimeout(() => {
              toast.classList.add('show');
          }, 100);
          
          // 숨기기
          setTimeout(() => {
              toast.classList.remove('show');
          }, 3000);
      }
      // 서명 관련 변수
      let canvas, ctx;
      let isDrawing = false;
      let currentSignatureType = '';
      let currentSignatureIndex = 0;

// 서명 모달 열기
function openSignatureModal(type, index) {
    console.log('🖊️ 서명 모달 열기:', type, index);
    
    currentSignatureType = type;
    currentSignatureIndex = index;
    
    // 기존 모달 제거
    const existingModal = document.getElementById('signatureModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 새 모달 생성
    const modalHTML = `
        <div class="signature-modal show" id="signatureModal">
            <div class="signature-popup">
                <div class="signature-header">
                    <h3 id="signatureTitle">${type === 'user' ? '사용자 서명' : '대리인 서명'}</h3>
                    <p>아래 영역에 손가락이나 펜으로 서명해주세요</p>
                </div>
                <canvas id="signatureCanvas" class="signature-canvas" width="500" height="200"></canvas>
                <div class="signature-controls">
                    <button class="signature-btn clear" onclick="clearSignature()">🗑️ 지우기</button>
                    <button class="signature-btn save" onclick="saveSignature()">✅ 저장</button>
                    <button class="signature-btn cancel" onclick="closeSignatureModal()">❌ 취소</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // 잠시 대기 후 캔버스 초기화 (DOM 생성 완료 대기)
    setTimeout(() => {
        // 캔버스 초기화
        canvas = document.getElementById('signatureCanvas');
        if (!canvas) {
            console.error('❌ 캔버스를 찾을 수 없습니다');
            return;
        }
        
        ctx = canvas.getContext('2d');
        
        // 캔버스 설정
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // 이벤트 리스너 추가
        setupCanvasEvents();
        
        // 캔버스 초기화
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 기존 서명이 있다면 표시
        const existingSignature = getExistingSignature(type, index);
        if (existingSignature) {
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = existingSignature;
        }
        
        console.log('✅ 서명 모달 생성 완료');
    }, 100);
}

      // 서명 모달 닫기
      function closeSignatureModal() {
          const modal = document.getElementById('signatureModal');
          if (modal) {
              modal.classList.remove('show');
              
              // 이벤트 리스너 제거
              removeCanvasEvents();
              
              // 모달 제거
              setTimeout(() => {
                  modal.remove();
              }, 300);
          }
      }

// 캔버스 이벤트 설정
function setupCanvasEvents() {
    if (!canvas) {
        console.error('❌ 캔버스가 없습니다');
        return;
    }
    
    console.log('🎯 캔버스 이벤트 설정 중...');
    
    // 기존 이벤트 리스너 제거
    removeCanvasEvents();
    
    // 마우스 이벤트
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // 터치 이벤트 (passive: false로 preventDefault 허용)
    canvas.addEventListener('touchstart', handleTouch, { passive: false });
    canvas.addEventListener('touchmove', handleTouch, { passive: false });
    canvas.addEventListener('touchend', handleTouch, { passive: false });
    
    console.log('✅ 캔버스 이벤트 설정 완료');
}

// 캔버스 이벤트 제거
function removeCanvasEvents() {
    if (canvas) {
        canvas.removeEventListener('mousedown', startDrawing);
        canvas.removeEventListener('mousemove', draw);
        canvas.removeEventListener('mouseup', stopDrawing);
        canvas.removeEventListener('mouseout', stopDrawing);
        canvas.removeEventListener('touchstart', handleTouch);
        canvas.removeEventListener('touchmove', handleTouch);
        canvas.removeEventListener('touchend', handleTouch);
    }
}

// 그리기 시작
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    
    let x, y;
    if (e.touches && e.touches[0]) {
        // 터치 이벤트
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
    } else {
        // 마우스 이벤트
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
    }
    
    ctx.beginPath();
    ctx.moveTo(x, y);
}

// 그리기
function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    
    const rect = canvas.getBoundingClientRect();
    
    let x, y;
    if (e.touches && e.touches[0]) {
        // 터치 이벤트
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
    } else {
        // 마우스 이벤트
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
    }
    
    ctx.lineTo(x, y);
    ctx.stroke();
}

// 그리기 중지
function stopDrawing(e) {
    if (isDrawing) {
        isDrawing = false;
        ctx.beginPath();
    }
}

// 터치 이벤트 처리
function handleTouch(e) {
    e.preventDefault();
    
    if (e.type === 'touchstart') {
        startDrawing(e);
    } else if (e.type === 'touchmove') {
        draw(e);
    } else if (e.type === 'touchend') {
        stopDrawing(e);
    }
}

      // 서명 지우기 (개선된 버전)
function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // fillRect 제거 - 투명 배경 유지
}

      // 서명 저장
      function saveSignature() {
          const signatureData = canvas.toDataURL();
          
          // 빈 서명 체크
          if (isCanvasEmpty()) {
              showToast('❌ 서명을 입력해주세요.', 'error');
              return;
          }
          
          // 서명 박스에 적용
          const signatureBox = document.querySelector(`[data-type="${currentSignatureType}"][data-index="${currentSignatureIndex}"]`);
          if (signatureBox) {
              signatureBox.style.backgroundImage = `url(${signatureData})`;
              signatureBox.classList.add('signed');
              signatureBox.textContent = '';
          }
          
          // 서명 데이터 저장
          saveSignatureData(currentSignatureType, currentSignatureIndex, signatureData);
          
          showToast('✅ 서명이 저장되었습니다.');
          closeSignatureModal();
      }

      // 캔버스가 비어있는지 확인
      function isCanvasEmpty() {
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          
          for (let i = 0; i < data.length; i += 4) {
              if (data[i + 3] !== 0) { // 알파 채널이 0이 아니면 그림이 있음
                  return false;
              }
          }
          return true;
      }

      // 서명 데이터 저장 (로컬 스토리지 사용)
      function saveSignatureData(type, index, data) {
          const key = `signature_${type}_${index}`;
          localStorage.setItem(key, data);
      }

      // 기존 서명 데이터 가져오기
      function getExistingSignature(type, index) {
          const key = `signature_${type}_${index}`;
          return localStorage.getItem(key);
      }
  </script>
</body>
</html>
